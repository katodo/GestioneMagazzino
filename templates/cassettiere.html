{% extends "base.html" %}
{% set container_class = "container-fluid" %}
{% set container_extra_class = "grid-page" %}
{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <div>
    <h3 class="mb-1">Casssettiere</h3>
    <div class="text-muted small">Visualizza e gestisci la griglia della cassettiera con maggiore spazio sullo schermo.</div>
  </div>
  <div class="d-flex flex-wrap gap-2 align-items-center">
    <a href="{{ url_for('articles') }}" class="btn btn-outline-secondary btn-sm">Vai agli articoli</a>
    {% if can_manage_items %}
    <form id="drawerPrintForm" method="post" class="d-flex flex-wrap gap-2 align-items-center">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="printModeToggle">
        <label class="form-check-label small" for="printModeToggle">Seleziona cassetti da stampare</label>
      </div>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" id="multiItemsOnlyToggle">
        <label class="form-check-label small" for="multiItemsOnlyToggle">Solo cassetti con più articoli (cartellini)</label>
      </div>
      <div class="small text-muted">Selezionati: <span id="selectedDrawerCount">0</span></div>
      <button class="btn btn-sm btn-primary" type="submit" formaction="{{ url_for('labels_pdf') }}">Stampa etichette (fogli)</button>
      <button class="btn btn-sm btn-outline-primary" type="submit" formaction="{{ url_for('cards_pdf') }}">Stampa cartellini (fogli)</button>
      <button class="btn btn-sm btn-outline-dark" type="submit" formaction="{{ url_for('dymo_labels_pdf') }}">Stampa etichette DYMO</button>
      <button class="btn btn-sm btn-outline-secondary" type="button" id="clearDrawerSelection">Svuota</button>
    </form>
    {% endif %}
  </div>
</div>

<form class="row g-2 mb-2">
  <div class="col-md-4 col-lg-3">
    <label class="form-label small text-muted mb-1">Cassettiera</label>
    <select name="cabinet_id" class="form-select" onchange="this.form.submit()">
      {% for c in cabinets %}
        <option value="{{ c.id }}" {{ 'selected' if c.id==selected_cab_id else '' }}>{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>
</form>

<div class="legend mb-2">
  <span style="background:black"></span> Bloccata
  {% for c in categories %}
    <span style="background:{{ c.color }}; margin-left:12px;"></span> {{ c.name }}
  {% endfor %}
</div>

<div class="grid-wrap p-2">
  {% if grid.rows and grid.cols %}
  <table class="grid-table" id="grid" data-cab="{{ grid.cab.id }}" data-comp="{{ grid.cab.comp }}">
    <thead>
      <tr>
        <th class="rowhdr">r\\c</th>
        {% for col in grid.cols %}
          <th>{{ col }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for r in grid.rows %}
      <tr>
        <th class="rowhdr">{{ r }}</th>
        {% for col in grid.cols %}
          {% set key = col ~ '-' ~ r %}
          {% if grid.merge_skips and grid.merge_skips.get(key) %}
          {% else %}
            {% set cell = grid.cells.get(key) %}
            {% set merge = grid.merge_anchors.get(key) if grid.merge_anchors else None %}
            {% set cell_label = cell.label if cell and cell.label else col ~ r %}
            {% set cell_custom = cell.label_custom if cell else False %}
            {% set display_label = cell_label %}
            {% if not cell_custom and cell and cell.entries and (cell.entries|length)>0 %}
              {% set first_entry = cell.entries[0] %}
              {% set display_label = first_entry.name if first_entry.name else first_entry.text %}
            {% endif %}
            {% if not cell %}
              <td class="cell-empty" data-col="{{ col }}" data-row="{{ r }}" data-cat="" data-label="{{ cell_label }}" data-slot-id="">
                <div class="cell-inner">{{ cell_label }}</div>
              </td>
            {% else %}
              {% if cell.blocked %}
                <td class="cell-blocked" data-col="{{ col }}" data-row="{{ r }}" data-cat="blocked" data-label="{{ display_label }}" data-slot-id="{{ cell.slot_id }}" {% if merge %}rowspan="{{ merge.rowspan }}" colspan="{{ merge.colspan }}"{% endif %}>{{ cell_label }}</td>
              {% elif cell.entries and (cell.entries|length)>0 %}
                {% set colhex = cell.entries[0].color %}
                <td class="cell-used{% if cell.entries and (cell.entries|length) > 1 %} cell-multi{% endif %}" style="background: {{ colhex }}" data-col="{{ col }}" data-row="{{ r }}" data-cat="{{ cell.cat_id or '' }}" data-label="{{ display_label }}" data-items='{{ cell.entries|tojson }}' data-slot-id="{{ cell.slot_id }}" {% if merge %}rowspan="{{ merge.rowspan }}" colspan="{{ merge.colspan }}"{% endif %}>
                  <div class="cell-inner">
                    {% if cell_custom %}
                      <div class="cell-line fw-bold">{{ cell_label }}</div>
                    {% else %}
                      {% for entry in cell.entries %}
                        <div class="cell-line">{{ entry.text }}</div>
                      {% endfor %}
                    {% endif %}
                  </div>
                </td>
              {% else %}
                <td class="cell-empty" data-col="{{ col }}" data-row="{{ r }}" data-cat="" data-label="{{ display_label }}" data-slot-id="{{ cell.slot_id }}" {% if merge %}rowspan="{{ merge.rowspan }}" colspan="{{ merge.colspan }}"{% endif %}>
                  <div class="cell-inner">{{ cell_label }}</div>
                </td>
                {% endif %}
              {% endif %}
            {% endif %}
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <div class="text-muted p-3">Configura una cassettiera per visualizzare la griglia.</div>
  {% endif %}
</div>

{% if can_manage_placements %}
<!-- Modal assegnazione -->
<div class="modal fade" id="assignModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <form id="assignForm">
      <div class="modal-header">
        <h5 class="modal-title">Assegna articolo a <span id="slotLabel"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <div class="sticky-top">
          <div class="mb-2"><input type="text" id="flt" class="form-control" placeholder="Filtra (testo libero)"></div>
        </div>
        <input type="hidden" name="cabinet_id" id="cab_id" value="{{ grid.cab.id if grid.cab else '' }}">
        <input type="hidden" name="col_code" id="col_code">
        <input type="hidden" name="row_num" id="row_num">
        <div class="mb-2"><small class="text-muted">Mostro solo articoli senza posizione. Se la cella è già occupata, verranno accettati solo articoli della stessa categoria.</small></div>
        <select name="item_id" id="item_id" size="12" class="form-select">
          {% for it in unplaced_json %}
            <option value="{{ it.id }}" data-cat="{{ it.category_id }}">{{ it.caption }}</option>
          {% endfor %}
        </select>
        <div class="mt-2"><small class="text-muted">Totale elementi: <span id="totCnt">{{ unplaced_json|length }}</span></small></div>
        <div id="assignError" class="text-danger small mt-2 d-none"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-primary">Assegna</button>
        <button type="button" class="btn btn-outline-secondary" id="btnSlotLabelFromAssign">Nome cassetto…</button>
        <button type="button" class="btn btn-outline-secondary" id="btnNewItem">Nuovo articolo…</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
      </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal contenuto cella -->
<div class="modal fade slot-modal" id="slotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Contenuto cella <span id="slotLabel2"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="slot_cab_id" value="{{ grid.cab.id if grid.cab else '' }}">
        <input type="hidden" id="slot_col_code">
        <input type="hidden" id="slot_row_num">
        <div id="slotEmptyMsg" class="text-muted small d-none">Nessun articolo assegnato a questa cella.</div>
        <table class="table table-sm align-middle mb-0" id="slotItemsTable">
          <thead>
            <tr><th>Articolo</th><th>Pos.</th><th>Q.ta</th><th>Azioni</th></tr>
          </thead>
          <tbody id="slotItemsBody"></tbody>
        </table>
        <div id="slotError" class="text-danger small mt-2 d-none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="btnSlotLabelFromSlot">Nome cassetto…</button>
        <button type="button" class="btn btn-outline-secondary" id="btnSlotAdd">Aggiungi articolo senza posizione…</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal override nome cassetto -->
<div class="modal fade" id="slotLabelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="slotLabelForm">
        <div class="modal-header">
          <h5 class="modal-title">Nome cassetto <span id="slotLabelTitle"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="cabinet_id" id="slotLabelCabId" value="{{ grid.cab.id if grid.cab else '' }}">
          <input type="hidden" name="col_code" id="slotLabelCol">
          <input type="hidden" name="row_num" id="slotLabelRow">
          <div class="mb-3">
            <label class="form-label">Visualizzazione cassettiera</label>
            <input type="text" class="form-control" name="display_label" id="slotLabelDisplay" placeholder="Lascia vuoto per usare la sigla standard">
            <div class="form-text">Default: <span id="slotLabelDefault"></span></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Stampa etichette</label>
            <input type="text" class="form-control" name="print_label" id="slotLabelPrint" placeholder="Lascia vuoto per usare la sigla standard">
          </div>
          <div class="alert alert-danger d-none" id="slotLabelError"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary">Salva</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<script>
const MQTT_PUBLISH_URL = '{{ url_for("mqtt_publish_slot") }}';
const IS_ADMIN = {{ 'true' if can_manage_placements else 'false' }};
{% if can_manage_placements %}
const UNPLACED = {{ unplaced_json|tojson }};
const CLEAR_URL_TEMPLATE = '{{ url_for("slot_clear_item", item_id=0) }}';
const SLOT_LABEL_URL = '{{ url_for("slot_label_endpoint") }}';

async function openSlotLabelModal(col, row){
  const grid = document.getElementById('grid');
  const cabId = document.getElementById('cab_id')?.value || grid?.dataset.cab;
  const errEl = document.getElementById('slotLabelError');
  if (errEl) {
    errEl.classList.add('d-none');
    errEl.textContent = '';
  }
  if (!cabId || !col || !row) {
    alert('Seleziona prima una cassettiera e una cella.');
    return;
  }
  try {
    const resp = await fetch(`${SLOT_LABEL_URL}?cabinet_id=${encodeURIComponent(cabId)}&col_code=${encodeURIComponent(col)}&row_num=${encodeURIComponent(row)}`);
    const j = await resp.json().catch(()=>({ok:false, error:'Errore di parsing'}));
    if (!j.ok) {
      if (errEl) {
        errEl.textContent = j.error || 'Errore durante il caricamento.';
        errEl.classList.remove('d-none');
      } else {
        alert(j.error || 'Errore durante il caricamento.');
      }
      return;
    }
    document.getElementById('slotLabelCol').value = col;
    document.getElementById('slotLabelRow').value = row;
    document.getElementById('slotLabelCabId').value = cabId;
    document.getElementById('slotLabelDisplay').value = j.display_label || '';
    document.getElementById('slotLabelPrint').value = j.print_label || '';
    document.getElementById('slotLabelDefault').textContent = j.default_label || `${col}${row}`;
    document.getElementById('slotLabelTitle').textContent = j.effective_display_label || `${col}${row}`;
    const modal = new bootstrap.Modal(document.getElementById('slotLabelModal'));
    modal.show();
  } catch (e) {
    if (errEl) {
      errEl.textContent = 'Errore di comunicazione.';
      errEl.classList.remove('d-none');
    } else {
      alert('Errore di comunicazione.');
    }
  }
}

function openAssignModal(col, row, catFilter, labelText){
  const modal = new bootstrap.Modal(document.getElementById('assignModal'));
  const label = labelText || `${col}${row}`;
  document.getElementById('slotLabel').textContent = label;
  document.getElementById('col_code').value = col;
  document.getElementById('row_num').value = row;
  const sel = document.getElementById('item_id');
  sel.innerHTML = '';
  let list = UNPLACED.slice();
  if (catFilter) list = list.filter(x => x.category_id == parseInt(catFilter));
  list.forEach(x=>{
    const o = document.createElement('option');
    o.value = x.id;
    o.textContent = x.caption;
    o.dataset.cat = x.category_id;
    sel.appendChild(o);
  });
  document.getElementById('totCnt').textContent = list.length;
  document.getElementById('flt').value = '';
  const errEl = document.getElementById('assignError');
  if (errEl) {
    errEl.classList.add('d-none');
    errEl.innerHTML = '';
  }
  modal.show();
}

function openSlotModal(col, row, labelText){
  const grid = document.getElementById('grid');
  const cabId = document.getElementById('cab_id')?.value || grid?.dataset.cab;
  if (!cabId) return;

  const modalEl = document.getElementById('slotModal');
  const modal = new bootstrap.Modal(modalEl);

  document.getElementById('slotLabel2').textContent = labelText || `${col}${row}`;
  document.getElementById('slot_col_code').value = col;
  document.getElementById('slot_row_num').value = row;
  document.getElementById('slotError').classList.add('d-none');
  document.getElementById('slotEmptyMsg').classList.add('d-none');

  const tbody = document.getElementById('slotItemsBody');
  tbody.innerHTML = '<tr><td colspan="4"><small class="text-muted">Caricamento...</small></td></tr>';

  fetch(`{{ url_for("slot_items") }}?cabinet_id=${encodeURIComponent(cabId)}&col_code=${encodeURIComponent(col)}&row_num=${encodeURIComponent(row)}`)
    .then(r => r.json())
    .then(j => {
      tbody.innerHTML = '';
      if (!j.ok) {
        document.getElementById('slotError').textContent = j.error || 'Errore caricamento contenuto.';
        document.getElementById('slotError').classList.remove('d-none');
        return;
      }
      const lbl2 = document.getElementById('slotLabel2');
      if (lbl2) {
        lbl2.textContent = j.slot_label_display || labelText || `${col}${row}`;
      }
      if (!j.items || !j.items.length) {
        document.getElementById('slotEmptyMsg').classList.remove('d-none');
        return;
      }

      j.items.forEach(it => {
        const tr = document.createElement('tr');

        const tdName = document.createElement('td');
        const measureInfo = (it.main_measure && it.main_measure.value)
          ? `${it.main_measure.label || (it.main_measure.mode === 'thickness' ? 'Spessore' : 'Lunghezza')}: ${it.main_measure.value} mm`
          : null;
        tdName.innerHTML = `
          <div class="d-flex align-items-start">
            <span class="badge-color flex-shrink-0 mt-1" style="background:${it.color};"></span>
            <div class="ms-2">
              <div class="fw-semibold">${it.name}</div>
              ${measureInfo ? `<div class="text-muted small">${measureInfo}</div>` : ''}
            </div>
          </div>`;

        const tdPos = document.createElement('td');
        tdPos.textContent = it.position_code || it.position || '';

        const tdQty = document.createElement('td');
        tdQty.textContent = (it.quantity !== null && it.quantity !== undefined) ? it.quantity : '';

        const tdActions = document.createElement('td');
        tdActions.className = 'text-nowrap';
        tdActions.innerHTML = `
          <button type="button" class="btn btn-sm btn-outline-primary me-1" data-edit-id="${it.id}">Modifica</button>
          <button type="button" class="btn btn-sm btn-outline-danger" data-remove-id="${it.id}">Rimuovi posizione</button>
        `;

        tr.appendChild(tdName);
        tr.appendChild(tdPos);
        tr.appendChild(tdQty);
        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });

      tbody.querySelectorAll('button[data-edit-id]').forEach(btn => {
        btn.addEventListener('click', () => {
          const id = btn.getAttribute('data-edit-id');
          window.location.href = '/admin/items/' + id + '/edit';
        });
      });

    tbody.querySelectorAll('button[data-remove-id]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const id = btn.getAttribute('data-remove-id');
        if (!confirm('Rimuovere la posizione per questo articolo?')) return;
        try {
          const url = CLEAR_URL_TEMPLATE.replace('0', id);
          const resp = await fetch(url, { method: 'POST' });
          const jj = await resp.json().catch(()=>({ok:false}));
          if (!jj.ok) {
            alert(jj.error || 'Errore nella rimozione.');
            return;
          }
          const modalEl = document.getElementById('slotModal');
          const inst = bootstrap.Modal.getInstance(modalEl);
          if (inst) inst.hide();
          location.reload();
        } catch (e) {
          alert('Errore di comunicazione.');
        }
      });
    });

    })
    .catch(() => {
      tbody.innerHTML = '';
      document.getElementById('slotError').textContent = 'Errore di comunicazione.';
      document.getElementById('slotError').classList.remove('d-none');
    });

  modal.show();
}

{% endif %}

function publishSlotMqtt(col, row) {
  const grid = document.getElementById('grid');
  const cabId = document.getElementById('cab_id')?.value || grid?.dataset.cab;
  if (!cabId || !MQTT_PUBLISH_URL) return;
  fetch(MQTT_PUBLISH_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ cabinet_id: cabId, col_code: col, row_num: row })
  }).catch(() => {});
}

function escapeHtml(str){
  return (str || '').replace(/[&<>"']/g, function(m) {
    return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m] || m);
  });
}

function initCellPopovers(gridId){
  const grid = document.getElementById(gridId);
  if (!grid || typeof bootstrap === 'undefined') return;
  grid.querySelectorAll('td.cell-used').forEach(td=>{
    const raw = td.dataset.items;
    if (!raw) return;
    let items = [];
    try { items = JSON.parse(raw); } catch { items = []; }
    if (!items.length) return;
    const content = items.map(it=>{
      const detailParts = [];
      if (it.thread_size) detailParts.push(it.thread_size);
      if (it.main_measure && it.main_measure.value) detailParts.push(`${it.main_measure.label}: ${it.main_measure.value}`);
      if (it.quantity !== null && it.quantity !== undefined) detailParts.push(`Q.ta ${it.quantity}`);
      if (it.share_drawer) detailParts.push('Condividi cassetto');
      return `
        <div class="d-flex align-items-start mb-1">
          <span class="badge-color flex-shrink-0 mt-1" style="background:${it.color || '#999'};"></span>
          <div class="ms-2">
            <div class="fw-semibold">${escapeHtml(it.name || it.text || '')}</div>
            ${it.description ? `<div class="small text-muted">${escapeHtml(it.description)}</div>` : ''}
            ${detailParts.length ? `<div class="small">${detailParts.map(escapeHtml).join(' - ')}</div>` : ''}
            ${it.position ? `<div class="small text-muted">Pos: ${escapeHtml(it.position)}</div>` : ''}
          </div>
        </div>`;
    }).join('');
    new bootstrap.Popover(td, {
      trigger:'hover focus',
      placement:'top',
      html:true,
      title:'Dettaglio cassetto',
      content: `<div class="popover-items">${content}</div>`
    });
  });
}

const selectedDrawerIds = new Set();
function updateDrawerSelectionCount(){
  const countEl = document.getElementById('selectedDrawerCount');
  if (countEl) countEl.textContent = selectedDrawerIds.size;
}
function clearDrawerSelection(){
  selectedDrawerIds.clear();
  document.querySelectorAll('#grid td.table-primary').forEach(td => td.classList.remove('table-primary'));
  updateDrawerSelectionCount();
}
function toggleDrawerSelection(td){
  const slotId = td?.dataset?.slotId;
  if (!slotId) return;
  if (selectedDrawerIds.has(slotId)) {
    selectedDrawerIds.delete(slotId);
    td.classList.remove('table-primary');
  } else {
    selectedDrawerIds.add(slotId);
    td.classList.add('table-primary');
  }
  updateDrawerSelectionCount();
}

function getMultiItemSlotIds() {
  const ids = new Set();
  document.querySelectorAll('#grid td.cell-used').forEach(td => {
    const slotId = td?.dataset?.slotId;
    if (!slotId) return;
    const raw = td.dataset.items;
    if (!raw) return;
    let items = [];
    try { items = JSON.parse(raw); } catch { items = []; }
    if (items.length > 1) ids.add(slotId);
  });
  return ids;
}

function parseRgbColor(color) {
  if (!color) return null;
  const rgbMatch = color.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)/i);
  if (rgbMatch) {
    return {
      r: Number(rgbMatch[1]),
      g: Number(rgbMatch[2]),
      b: Number(rgbMatch[3])
    };
  }
  const hexMatch = color.trim().match(/^#([0-9a-f]{3}|[0-9a-f]{6})$/i);
  if (hexMatch) {
    let hex = hexMatch[1];
    if (hex.length === 3) {
      hex = hex.split('').map(ch => ch + ch).join('');
    }
    return {
      r: parseInt(hex.slice(0, 2), 16),
      g: parseInt(hex.slice(2, 4), 16),
      b: parseInt(hex.slice(4, 6), 16)
    };
  }
  return null;
}

function updateCellTextContrast() {
  document.querySelectorAll('#grid td.cell-used, #grid td.cell-blocked').forEach(cell => {
    const inner = cell.querySelector('.cell-inner');
    if (!inner) return;
    const bgColor = window.getComputedStyle(cell).backgroundColor;
    const rgb = parseRgbColor(bgColor);
    if (!rgb) return;
    const luminance = (0.2126 * rgb.r + 0.7152 * rgb.g + 0.0722 * rgb.b) / 255;
    const textColor = luminance > 0.6 ? '#111' : '#fff';
    inner.style.setProperty('--cell-text-color', textColor);
    inner.style.textShadow = textColor === '#111'
      ? '0 1px 1px rgba(255,255,255,0.25)'
      : '0 1px 1px rgba(0,0,0,0.35)';
  });
}

document.addEventListener('DOMContentLoaded', function(){
  const grid = document.getElementById('grid');
  if (!grid) return;
  let pendingUsedCell = null;
  initCellPopovers('grid');
  updateCellTextContrast();

  const printModeToggle = document.getElementById('printModeToggle');
  document.getElementById('clearDrawerSelection')?.addEventListener('click', clearDrawerSelection);
  if (printModeToggle) {
    printModeToggle.addEventListener('change', () => {
      if (!printModeToggle.checked) {
        clearDrawerSelection();
      }
    });
  }
  const drawerPrintForm = document.getElementById('drawerPrintForm');
  if (drawerPrintForm) {
    drawerPrintForm.addEventListener('submit', (event) => {
      const submitter = event.submitter;
      const isCardsSubmit = submitter?.getAttribute('formaction')?.includes('{{ url_for("cards_pdf") }}');
      const multiToggle = document.getElementById('multiItemsOnlyToggle');
      let idsToSubmit = new Set(selectedDrawerIds);
      if (isCardsSubmit && multiToggle?.checked) {
        const multiIds = getMultiItemSlotIds();
        if (idsToSubmit.size) {
          idsToSubmit = new Set([...idsToSubmit].filter(id => multiIds.has(id)));
        } else {
          idsToSubmit = multiIds;
        }
      }
      drawerPrintForm.querySelectorAll('input[name="slot_ids"]').forEach(el => el.remove());
      idsToSubmit.forEach(id => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'slot_ids';
        input.value = id;
        drawerPrintForm.appendChild(input);
      });
    });
  }
  updateDrawerSelectionCount();

  {% if can_manage_placements %}
  const assignModalEl = document.getElementById('assignModal');
  assignModalEl?.addEventListener('shown.bs.modal', () => {
    document.getElementById('flt')?.focus();
  });

  const slotModalEl = document.getElementById('slotModal');
  slotModalEl?.addEventListener('shown.bs.modal', () => {
    document.getElementById('slotItemsTable')?.scrollIntoView({ block: 'nearest' });
  });
  {% endif %}

  grid.addEventListener('click', function(e){
    const td = e.target.closest('td');
    if (!td) return;
    if (td.classList.contains('cell-blocked')) { alert('Cella bloccata.'); return; }

    const col = td.dataset.col;
    const row = td.dataset.row;
    const cat = td.dataset.cat;
    const label = td.dataset.label;

    if (!col || !row) return;
    if (cat === 'blocked') { alert('Cella bloccata.'); return; }

    if (printModeToggle?.checked) {
      toggleDrawerSelection(td);
      return;
    }

    publishSlotMqtt(col, row);

    if (!IS_ADMIN) {
      pendingUsedCell = null;
      return;
    }

    const cellKey = `${col}-${row}`;
    if (td.classList.contains('cell-used')) {
      if (pendingUsedCell === cellKey) {
        pendingUsedCell = null;
        openSlotModal(col, row, label);
      } else {
        pendingUsedCell = cellKey;
      }
    } else {
      pendingUsedCell = null;
      openAssignModal(col, row, cat || null, label);
    }
  });

  {% if can_manage_placements %}
  document.getElementById('flt')?.addEventListener('input', function(){
    const term = this.value.toLowerCase();
    const sel = document.getElementById('item_id');
    let visibleCount = 0;
    Array.from(sel.options).forEach(opt=>{
      const show = !term || opt.textContent.toLowerCase().includes(term);
      opt.hidden = !show;
      if (show) visibleCount++;
    });
    document.getElementById('totCnt').textContent = visibleCount;
  });

  document.getElementById('assignForm')?.addEventListener('submit', async function(ev){
    ev.preventDefault();
    const form = ev.target;
    const submitAssign = async (forceShare=false) => {
      const fd = new FormData(form);
      if (forceShare) fd.append('force_share', '1');
      const r = await fetch('{{ url_for("grid_assign") }}', { method:'POST', body: fd });
      const j = await r.json().catch(()=>({ok:false, error:'Errore sconosciuto'}));
      if (j.ok) {
        location.reload();
        return;
      }
      if (j.share_blockers && !forceShare) {
        const names = j.share_blockers.map(b => escapeHtml(b.name || '')).filter(Boolean);
        const blockersList = names.length ? `<ul class="mb-2">${names.map(n => `<li>${n}</li>`).join('')}</ul>` : '';
        const el = document.getElementById('assignError');
        if (el) {
          el.innerHTML = `Il cassetto contiene articoli che non supportano la condivisione. Abilita "Permetti di condividere il cassetto con altri articoli compatibili" su tutti gli articoli coinvolti per procedere.${blockersList}<button type="button" class="btn btn-sm btn-primary" data-role="force-share">Abilita e assegna</button>`;
          el.classList.remove('d-none');
          const btnForce = el.querySelector('[data-role="force-share"]');
          btnForce?.addEventListener('click', () => submitAssign(true), { once: true });
        }
        return;
      }
      const el = document.getElementById('assignError');
      el.textContent = j.error || 'Errore di assegnazione';
      el.classList.remove('d-none');
    };
    submitAssign();
  });

  const btnNewItem = document.getElementById('btnNewItem');
  if (btnNewItem) {
    btnNewItem.addEventListener('click', function () {
      const cabId = document.getElementById('cab_id').value || grid.dataset.cab;
      const col   = document.getElementById('col_code').value;
      const row   = document.getElementById('row_num').value;

      if (!cabId || !col || !row) {
        return;
      }

      const params = new URLSearchParams({
        new_for_cab: cabId,
        new_for_col: col,
        new_for_row: row
      });

      window.location.href = '{{ url_for("articles") }}?' + params.toString();
    });
  }

  const btnSlotAdd = document.getElementById('btnSlotAdd');
  if (btnSlotAdd) {
    btnSlotAdd.addEventListener('click', function () {
      const col = document.getElementById('slot_col_code').value;
      const row = document.getElementById('slot_row_num').value;
      if (!col || !row) return;

      const modalEl = document.getElementById('slotModal');
      const inst = bootstrap.Modal.getInstance(modalEl);
      inst?.hide();

      openAssignModal(col, row, null);
    });
  }

  const btnSlotLabelFromAssign = document.getElementById('btnSlotLabelFromAssign');
  if (btnSlotLabelFromAssign) {
    btnSlotLabelFromAssign.addEventListener('click', () => {
      const col = document.getElementById('col_code').value;
      const row = document.getElementById('row_num').value;
      if (!col || !row) {
        alert('Compila colonna e riga per impostare il nome cassetto.');
        return;
      }
      openSlotLabelModal(col, row);
    });
  }

  const btnSlotLabelFromSlot = document.getElementById('btnSlotLabelFromSlot');
  if (btnSlotLabelFromSlot) {
    btnSlotLabelFromSlot.addEventListener('click', () => {
      const col = document.getElementById('slot_col_code').value;
      const row = document.getElementById('slot_row_num').value;
      if (!col || !row) return;
      openSlotLabelModal(col, row);
    });
  }

  const slotLabelForm = document.getElementById('slotLabelForm');
  if (slotLabelForm) {
    slotLabelForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const fd = new FormData(slotLabelForm);
      const errEl = document.getElementById('slotLabelError');
      if (errEl) {
        errEl.classList.add('d-none');
        errEl.textContent = '';
      }
      try {
        const resp = await fetch(SLOT_LABEL_URL, { method: 'POST', body: fd });
        const j = await resp.json().catch(()=>({ok:false, error:'Errore di parsing'}));
        if (!resp.ok || !j.ok) {
          if (errEl) {
            errEl.textContent = j.error || 'Errore durante il salvataggio.';
            errEl.classList.remove('d-none');
          } else {
            alert(j.error || 'Errore durante il salvataggio.');
          }
          return;
        }
        const modalEl = document.getElementById('slotLabelModal');
        const inst = bootstrap.Modal.getInstance(modalEl);
        inst?.hide();
        location.reload();
      } catch (e) {
        if (errEl) {
          errEl.textContent = 'Errore di comunicazione.';
          errEl.classList.remove('d-none');
        } else {
          alert('Errore di comunicazione.');
        }
      }
    });
  }
  {% endif %}
});
</script>
{% endblock %}
