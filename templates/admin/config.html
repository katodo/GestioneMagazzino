{% extends "base.html" %}
{% block content %}
<h3>Configurazione</h3>
<div class="row g-3">
  <div class="col-xl-8">
    <div class="form-section">
      <h5>Campi per categoria</h5>
      <p class="text-muted mb-2">Categorie in riga, attributi in colonna: spunta i checkbox per attivare il campo e salva la riga.</p>
      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
          <thead>
            <tr>
              <th style="width:180px;">Categoria</th>
              {% for field in field_defs %}
              <th class="text-center">{{ field.label }}</th>
              {% endfor %}
              <th style="width:90px;"></th>
            </tr>
          </thead>
          <tbody>
            {% for cat in categories %}
            <tr>
              <td class="fw-semibold">{{ cat.name }}</td>
              {% for field in field_defs %}
              <td class="text-center">
                <div class="form-check d-flex justify-content-center m-0">
                  <input class="form-check-input" type="checkbox" name="field_keys" value="{{ field.key }}" id="field-{{ cat.id }}-{{ field.key }}" form="cat-fields-{{ cat.id }}" {{ 'checked' if field.key in category_fields.get(cat.id, []) else '' }}>
                </div>
              </td>
              {% endfor %}
              <td class="text-end">
                <form method="post" action="{{ url_for('update_category_fields', cat_id=cat.id) }}" id="cat-fields-{{ cat.id }}">
                  <button class="btn btn-sm btn-primary">Salva</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-xl-4">
    <div class="form-section h-100">
      <h5>Stampa etichette & QR</h5>
      <form method="post" action="{{ url_for('update_settings') }}" class="row g-2">
        <div class="col-6"><label class="form-label">Larghezza (mm)</label><input type="number" step="0.1" class="form-control" name="label_w_mm" value="{{ settings.label_w_mm }}"></div>
        <div class="col-6"><label class="form-label">Altezza (mm)</label><input type="number" step="0.1" class="form-control" name="label_h_mm" value="{{ settings.label_h_mm }}"></div>
        <div class="col-6"><label class="form-label">Margini top/bottom (mm)</label><input type="number" step="0.1" class="form-control" name="margin_tb_mm" value="{{ settings.margin_tb_mm }}"></div>
        <div class="col-6"><label class="form-label">Margini sx/dx (mm)</label><input type="number" step="0.1" class="form-control" name="margin_lr_mm" value="{{ settings.margin_lr_mm }}"></div>
        <div class="col-6"><label class="form-label">Spazio tra etichette (mm)</label><input type="number" step="0.1" class="form-control" name="gap_mm" value="{{ settings.gap_mm }}"></div>
        <div class="col-6">
          <label class="form-label">Orientamento</label>
          <select class="form-select" name="orientation_landscape">
            <option value="1" {{ 'selected' if settings.orientation_landscape else '' }}>Orizzontale</option>
            <option value=""  {{ '' if settings.orientation_landscape else 'selected' }}>Verticale</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">QR attivo di default</label>
          <select class="form-select" name="qr_default">
            <option value="1" {{ 'selected' if settings.qr_default else '' }}>Sì</option>
            <option value="">No</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">QR Base URL (opz.)</label>
          <input class="form-control" name="qr_base_url" placeholder="https://magazzino.local" value="{{ settings.qr_base_url or '' }}">
          <small class="text-muted">Se vuoto, uso l'host corrente.</small>
        </div>
        <div class="col-12 text-end mt-2"><button class="btn btn-primary">Salva impostazioni</button></div>
      </form>
    </div>
  </div>

  <div class="col-xl-4">
    <div class="form-section">
      <h5>Campi personalizzati</h5>
      <form method="post" action="{{ url_for('add_custom_field') }}" class="row g-2 mb-3">
        <div class="col-md-6">
          <label class="form-label">Nome</label>
          <input class="form-control" name="name" placeholder="Es. Classe" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Tipo</label>
          <select class="form-select" name="field_type">
            <option value="text">Testo</option>
            <option value="number">Numero</option>
            <option value="select">Selezione</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Unità (opz.)</label>
          <input class="form-control" name="unit" placeholder="mm, V, ...">
        </div>
        <div class="col-md-6">
          <label class="form-label">Ordine</label>
          <input type="number" class="form-control" name="sort_order" value="0">
        </div>
        <div class="col-12">
          <label class="form-label">Opzioni (solo per selezione)</label>
          <textarea class="form-control" name="options" rows="2" placeholder="Una per riga"></textarea>
        </div>
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_active" id="is_active_new" checked>
            <label class="form-check-label" for="is_active_new">Attivo</label>
          </div>
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary">Aggiungi campo</button>
        </div>
      </form>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Campo</th>
              <th style="width:110px;">Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for field in custom_fields %}
            <tr>
              <td>
                <form method="post" action="{{ url_for('update_custom_field', field_id=field.id) }}" class="row g-2">
                  <div class="col-md-6">
                    <input class="form-control" name="name" value="{{ field.name }}">
                  </div>
                  <div class="col-md-3">
                    <select class="form-select" name="field_type">
                      <option value="text" {{ 'selected' if field.field_type == 'text' else '' }}>Testo</option>
                      <option value="number" {{ 'selected' if field.field_type == 'number' else '' }}>Numero</option>
                      <option value="select" {{ 'selected' if field.field_type == 'select' else '' }}>Selezione</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <input class="form-control" name="unit" placeholder="Unità" value="{{ field.unit or '' }}">
                  </div>
                  <div class="col-md-3">
                    <input type="number" class="form-control" name="sort_order" value="{{ field.sort_order }}">
                  </div>
                  <div class="col-md-6">
                    <textarea class="form-control" name="options" rows="2" placeholder="Opzioni">{{ field.options | join('\n') }}</textarea>
                  </div>
                  <div class="col-md-3">
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" name="is_active" id="field-active-{{ field.id }}" {{ 'checked' if field.is_active else '' }}>
                      <label class="form-check-label" for="field-active-{{ field.id }}">Attivo</label>
                    </div>
                  </div>
                  <div class="col-md-3 text-end">
                    <button class="btn btn-sm btn-primary w-100">Salva</button>
                  </div>
                </form>
              </td>
              <td class="text-end">
                <form method="post" action="{{ url_for('delete_custom_field', field_id=field.id) }}" onsubmit="return confirm('Eliminare il campo personalizzato?')">
                  <button class="btn btn-sm btn-outline-danger w-100">Elimina</button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="2" class="text-muted">Nessun campo personalizzato.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-xl-8">
    <div class="form-section">
      <h5>Ubicazioni</h5>
      <form method="post" action="{{ url_for('add_location') }}" class="row g-2 mb-2">
        <div class="col-md-9"><input class="form-control" name="name" placeholder="Nome ubicazione"></div>
        <div class="col-md-3"><button class="btn btn-primary w-100">Aggiungi</button></div>
      </form>
      <table class="table table-sm table-striped">
        <thead><tr><th>ID</th><th>Nome</th><th>Azione</th></tr></thead>
        <tbody>
          {% for l in locations %}
          <tr>
            <td>{{ l.id }}</td>
            <td>
              <form method="post" action="{{ url_for('update_location', loc_id=l.id) }}" class="row g-2">
                <div class="col-md-9"><input class="form-control" name="name" value="{{ l.name }}"></div>
                <div class="col-md-3">
                  <button class="btn btn-sm btn-primary">Salva</button>
                  <button formaction="{{ url_for('delete_location', loc_id=l.id) }}" formmethod="post" class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminare ubicazione?')">Elimina</button>
                </div>
              </form>
            </td>
            <td></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section">
      <h5>Cassettiere</h5>
      <form method="post" action="{{ url_for('add_cabinet') }}" class="row g-2 mb-2">
        <div class="col-md-4">
          <label class="form-label small text-muted mb-1">Ubicazione</label>
          <select class="form-select" name="location_id" required>
            {% for l in locations %}
              <option value="{{ l.id }}">{{ l.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label small text-muted mb-1">Nome</label>
          <input class="form-control" name="name" placeholder="Nome cassettiera">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted mb-1">Righe</label>
          <input type="number" min="1" max="128" class="form-control" name="rows_max" value="128">
        </div>
        <div class="col-md-1">
          <label class="form-label small text-muted mb-1">Colonne</label>
          <input class="form-control" name="cols_max" placeholder="ZZ" value="ZZ" maxlength="2">
        </div>
        <div class="col-md-1">
          <label class="form-label small text-muted mb-1">Comp.</label>
          <input type="number" min="1" class="form-control" name="compartments_per_slot" value="6">
        </div>
        <div class="col-md-12 text-end"><button class="btn btn-primary">Aggiungi</button></div>
      </form>

      <table class="table table-striped">
        <thead><tr><th>ID</th><th>Ubicazione</th><th>Nome</th><th>Righe</th><th>Colonne</th><th>Comp.</th><th>Azione</th></tr></thead>
        <tbody>
          {% for c,l in cabinets %}
          <tr>
            <td>{{ c.id }}</td>
            <td>{{ l.name }}</td>
            <td>
              <input class="form-control" name="name" value="{{ c.name }}" form="cabinet-form-{{ c.id }}">
            </td>
            <td>
              <input type="number" min="1" max="128" class="form-control" name="rows_max" value="{{ c.rows_max }}" form="cabinet-form-{{ c.id }}">
            </td>
            <td>
              <input class="form-control" name="cols_max" value="{{ c.cols_max }}" maxlength="2" form="cabinet-form-{{ c.id }}">
            </td>
            <td>
              <input type="number" min="1" class="form-control" name="compartments_per_slot" value="{{ c.compartments_per_slot }}" form="cabinet-form-{{ c.id }}">
            </td>
            <td class="text-end">
              <form method="post" action="{{ url_for('update_cabinet', cab_id=c.id) }}" id="cabinet-form-{{ c.id }}" class="d-grid gap-1"></form>
              <div class="d-grid gap-1">
                <button class="btn btn-sm btn-primary" form="cabinet-form-{{ c.id }}">Salva</button>
                <button formaction="{{ url_for('delete_cabinet', cab_id=c.id) }}" formmethod="post" class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminare cassettiera?')" form="cabinet-form-{{ c.id }}">Elimina</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section">
      <h5>Fusione cassetti</h5>
      <form method="post" action="{{ url_for('add_drawer_merge') }}" class="row g-2 mb-2">
        <div class="col-md-4">
          <select class="form-select" name="cabinet_id" required>
            {% for c,l in cabinets %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2"><input class="form-control" name="col_start" placeholder="Col. da (es. A)" required></div>
        <div class="col-md-2"><input type="number" min="1" max="128" class="form-control" name="row_start" placeholder="Riga da" required></div>
        <div class="col-md-2"><input class="form-control" name="col_end" placeholder="Col. a (es. C)" required></div>
        <div class="col-md-2"><input type="number" min="1" max="128" class="form-control" name="row_end" placeholder="Riga a" required></div>
        <div class="col-md-12 text-end"><button class="btn btn-primary">Aggiungi fusione</button></div>
      </form>
      <div class="form-text mb-2">Le celle adiacenti selezionate saranno visualizzate come un unico cassetto.</div>
      <table class="table table-striped">
        <thead><tr><th>Cassettiera</th><th>Da</th><th>A</th><th>Azione</th></tr></thead>
        <tbody>
          {% for m,c in drawer_merges %}
          <tr>
            <td>{{ c.name }}</td>
            <td>{{ m.col_start }}{{ m.row_start }}</td>
            <td>{{ m.col_end }}{{ m.row_end }}</td>
            <td>
              <form method="post" action="{{ url_for('delete_drawer_merge', merge_id=m.id) }}">
                <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminare fusione?')">Elimina</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="text-muted">Nessuna fusione configurata.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section">
      <h5>Sposta / Scambia cassetti</h5>
      <form method="post" action="{{ url_for('move_slot') }}" class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Origine</label>
          <select class="form-select" name="cabinet_from">
            {% for c,l in cabinets %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2"><label class="form-label">Col</label><input class="form-control" name="col_from"></div>
        <div class="col-md-2"><label class="form-label">Riga</label><input type="number" class="form-control" name="row_from"></div>

        <div class="col-md-3">
          <label class="form-label">Destinazione</label>
          <select class="form-select" name="cabinet_to">
            {% for c,l in cabinets %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2"><label class="form-label">Col</label><input class="form-control" name="col_to"></div>
        <div class="col-md-2"><label class="form-label">Riga</label><input type="number" class="form-control" name="row_to"></div>

        <div class="col-md-2"><label class="form-label"> </label><div class="form-check"><input class="form-check-input" type="checkbox" name="swap" id="swap"> <label class="form-check-label" for="swap">Scambia</label></div></div>
        <div class="col-md-2 align-self-end"><button class="btn btn-primary w-100">Esegui</button></div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
