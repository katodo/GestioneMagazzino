{% extends "base.html" %}
{% block content %}
<h3>Configurazione</h3>
<nav class="mb-3">
  <ul class="nav nav-pills flex-wrap gap-2">
    {% if can_manage_config %}
    <li class="nav-item"><a class="nav-link" href="#categorie">Categorie</a></li>
    <li class="nav-item"><a class="nav-link" href="#sottotipi">Sottotipi</a></li>
    <li class="nav-item"><a class="nav-link" href="#materiali">Materiali</a></li>
    <li class="nav-item"><a class="nav-link" href="#finiture">Finiture</a></li>
    <li class="nav-item"><a class="nav-link" href="#campi-categoria">Campi per categoria</a></li>
    <li class="nav-item"><a class="nav-link" href="#stampa-etichette">Stampa etichette & QR</a></li>
    <li class="nav-item"><a class="nav-link" href="#mqtt">MQTT</a></li>
    <li class="nav-item"><a class="nav-link" href="#campi-personalizzati">Campi personalizzati</a></li>
    <li class="nav-item"><a class="nav-link" href="#ubicazioni">Ubicazioni</a></li>
    <li class="nav-item"><a class="nav-link" href="#cassettiere">Cassettiere</a></li>
    <li class="nav-item"><a class="nav-link" href="#fusione-cassetti">Fusione cassetti</a></li>
    <li class="nav-item"><a class="nav-link" href="#sposta-cassetti">Sposta / Scambia cassetti</a></li>
    {% endif %}
    {% if can_manage_users %}
      <li class="nav-item"><a class="nav-link" href="#utenti">Utenti</a></li>
    {% endif %}
    {% if can_manage_roles %}
      <li class="nav-item"><a class="nav-link" href="#ruoli">Ruoli</a></li>
      <li class="nav-item"><a class="nav-link" href="#permessi">Permessi</a></li>
    {% endif %}
  </ul>
</nav>
<div class="row g-3">
  {% if can_manage_config %}
  <div class="col-12">
    <div class="form-section" id="categorie">
      <h5>Categorie</h5>
      <p class="text-muted mb-2 small">Gestisci nome e colore delle categorie usate in tutto il prodotto.</p>
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr><th style="width:60px;">ID</th><th>Nome</th><th style="width:70px;">Colore</th><th style="width:180px;">Lunghezza/Spessore</th><th class="text-end" style="width:150px;">Azione</th></tr>
        </thead>
        <tbody>
          {% for c in categories %}
          <tr>
            <td>{{ c.id }}</td>
            <td>
              <input class="form-control" name="name" value="{{ c.name }}" form="cat-{{ c.id }}">
            </td>
            <td>
              <input type="color" class="form-control form-control-color" name="color" value="{{ c.color }}" form="cat-{{ c.id }}">
            </td>
            <td>
              <select class="form-select" name="main_measure_mode" form="cat-{{ c.id }}">
                <option value="length" {{ 'selected' if c.main_measure_mode == 'length' else '' }}>Lunghezza</option>
                <option value="thickness" {{ 'selected' if c.main_measure_mode == 'thickness' else '' }}>Spessore</option>
              </select>
            </td>
            <td class="text-end">
              <form method="post" action="{{ url_for('update_category', cat_id=c.id) }}" id="cat-{{ c.id }}" class="d-inline-block">
                <button class="btn btn-sm btn-primary">Salva</button>
              </form>
              {% if c.id in used_categories %}
                <button class="btn btn-sm btn-outline-secondary ms-1" type="button" disabled title="Categoria in uso">Elimina</button>
              {% else %}
                <form method="post" action="{{ url_for('delete_category', cat_id=c.id) }}" class="d-inline-block" onsubmit="return confirm('Eliminare categoria?')">
                  <button class="btn btn-sm btn-outline-danger ms-1">Elimina</button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="pt-2 border-top mt-2">
        <h6 class="mb-2">Nuova categoria</h6>
        <form method="post" action="{{ url_for('add_category') }}" class="row g-2 align-items-center">
          <div class="col-md-6">
            <input class="form-control" name="name" placeholder="Nome categoria">
          </div>
          <div class="col-md-3">
            <input type="color" class="form-control form-control-color" name="color" value="#607D8B">
          </div>
          <div class="col-md-3">
            <select class="form-select" name="main_measure_mode">
              <option value="length">Lunghezza</option>
              <option value="thickness">Spessore</option>
            </select>
          </div>
          <div class="col-md-3">
            <button class="btn btn-primary w-100">Aggiungi</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section" id="sottotipi">
      <h5>Sottotipi (forme)</h5>
      <form method="post" action="{{ url_for('add_subtype') }}" class="row g-2 align-items-center mb-2">
        <div class="col-md-4">
          <select class="form-select" name="category_id" required>
            <option value="">Categoria...</option>
            {% for c in categories %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-6">
          <input class="form-control" name="name" placeholder="Nome sottotipo (es. Testa cilindrica)">
        </div>
        <div class="col-md-2">
          <button class="btn btn-primary w-100">Aggiungi</button>
        </div>
      </form>

      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr><th style="width:60px;">ID</th><th style="width:220px;">Categoria</th><th>Nome</th><th class="text-end" style="width:150px;">Azione</th></tr>
        </thead>
        <tbody>
          {% for st, c in subtypes %}
          <tr>
            <td>{{ st.id }}</td>
            <td>
              <select class="form-select" name="category_id" form="subtype-{{ st.id }}">
                {% for cat in categories %}
                  <option value="{{ cat.id }}" {{ 'selected' if cat.id == st.category_id else '' }}>{{ cat.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td>
              <input class="form-control" name="name" value="{{ st.name }}" form="subtype-{{ st.id }}">
            </td>
            <td class="text-end">
              <form method="post" action="{{ url_for('update_subtype', st_id=st.id) }}" id="subtype-{{ st.id }}" class="d-inline-block">
                <button class="btn btn-sm btn-primary">Salva</button>
              </form>
              {% if st.id in used_subtypes %}
                <button class="btn btn-sm btn-outline-secondary ms-1" type="button" disabled title="Sottotipo in uso">Elimina</button>
              {% else %}
                <form method="post" action="{{ url_for('delete_subtype', st_id=st.id) }}" class="d-inline-block" onsubmit="return confirm('Eliminare sottotipo?')">
                  <button class="btn btn-sm btn-outline-danger ms-1">Elimina</button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="form-section h-100" id="materiali">
      <h5>Materiali</h5>
      <table class="table table-sm table-striped align-middle mb-3">
        <thead>
          <tr><th style="width:60px;">ID</th><th>Nome</th><th class="text-end" style="width:150px;">Azione</th></tr>
        </thead>
        <tbody>
          {% for m in materials %}
          <tr>
            <td>{{ m.id }}</td>
            <td>
              <input class="form-control" name="name" value="{{ m.name }}" form="material-{{ m.id }}">
            </td>
            <td class="text-end">
              <form method="post" action="{{ url_for('update_material', mat_id=m.id) }}" id="material-{{ m.id }}" class="d-inline-block">
                <button class="btn btn-sm btn-primary">Salva</button>
              </form>
              {% if m.id in used_materials %}
                <button class="btn btn-sm btn-outline-secondary ms-1" type="button" disabled title="Materiale in uso">Elimina</button>
              {% else %}
                <form method="post" action="{{ url_for('delete_material', mat_id=m.id) }}" class="d-inline-block" onsubmit="return confirm('Eliminare materiale?')">
                  <button class="btn btn-sm btn-outline-danger ms-1">Elimina</button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <form method="post" action="{{ url_for('add_material') }}" class="row g-2">
        <div class="col-8">
          <input class="form-control" name="name" placeholder="Descrizione materiale">
        </div>
        <div class="col-4">
          <button class="btn btn-primary w-100">Nuovo materiale</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="form-section h-100" id="finiture">
      <h5>Finiture</h5>
      <table class="table table-sm table-striped align-middle mb-3">
        <thead>
          <tr><th style="width:60px;">ID</th><th>Nome</th><th class="text-end" style="width:150px;">Azione</th></tr>
        </thead>
        <tbody>
          {% for f in finishes %}
          <tr>
            <td>{{ f.id }}</td>
            <td>
              <input class="form-control" name="name" value="{{ f.name }}" form="finish-{{ f.id }}">
            </td>
            <td class="text-end">
              <form method="post" action="{{ url_for('update_finish', fin_id=f.id) }}" id="finish-{{ f.id }}" class="d-inline-block">
                <button class="btn btn-sm btn-primary">Salva</button>
              </form>
              {% if f.id in used_finishes %}
                <button class="btn btn-sm btn-outline-secondary ms-1" type="button" disabled title="Finitura in uso">Elimina</button>
              {% else %}
                <form method="post" action="{{ url_for('delete_finish', fin_id=f.id) }}" class="d-inline-block" onsubmit="return confirm('Eliminare finitura?')">
                  <button class="btn btn-sm btn-outline-danger ms-1">Elimina</button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      <form method="post" action="{{ url_for('add_finish') }}" class="row g-2">
        <div class="col-8">
          <input class="form-control" name="name" placeholder="Descrizione finitura">
        </div>
        <div class="col-4">
          <button class="btn btn-primary w-100">Nuova finitura</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section" id="campi-categoria">
      <h5>Campi per categoria</h5>
      <p class="text-muted mb-2">Categorie in riga, attributi in colonna: spunta i checkbox per attivare il campo e salva la riga.</p>
      <div class="table-responsive">
        <table class="table table-sm table-bordered align-middle">
          <thead>
            <tr>
              <th style="width:180px;">Categoria</th>
              {% for field in field_defs %}
              <th class="text-center">{{ field.label }}</th>
              {% endfor %}
              <th style="width:90px;"></th>
            </tr>
          </thead>
          <tbody>
            {% for cat in categories %}
            <tr>
              <td class="fw-semibold">{{ cat.name }}</td>
              {% for field in field_defs %}
              <td class="text-center">
                <div class="form-check d-flex justify-content-center m-0">
                  {% set field_used = field.key in used_category_fields.get(cat.id, []) %}
                  {% set field_enabled = field_used or field.key in category_fields.get(cat.id, []) %}
                  <input class="form-check-input" type="checkbox" name="field_keys" value="{{ field.key }}" id="field-{{ cat.id }}-{{ field.key }}" form="cat-fields-{{ cat.id }}" {{ 'checked' if field_enabled else '' }} {{ 'disabled' if field_used else '' }} title="{{ 'Campo in uso: non disattivabile' if field_used else '' }}">
                </div>
              </td>
              {% endfor %}
              <td class="text-end">
                <form method="post" action="{{ url_for('update_category_fields', cat_id=cat.id) }}" id="cat-fields-{{ cat.id }}">
                  <button class="btn btn-sm btn-primary">Salva</button>
                </form>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section" id="stampa-etichette">
      <h5>Stampa etichette & QR</h5>
      <form method="post" action="{{ url_for('update_settings') }}" class="row g-2">
        <div class="col-6"><label class="form-label">Larghezza (mm)</label><input type="number" step="0.1" class="form-control" name="label_w_mm" value="{{ settings.label_w_mm }}"></div>
        <div class="col-6"><label class="form-label">Altezza (mm)</label><input type="number" step="0.1" class="form-control" name="label_h_mm" value="{{ settings.label_h_mm }}"></div>
        <div class="col-6"><label class="form-label">Margini top/bottom (mm)</label><input type="number" step="0.1" class="form-control" name="margin_tb_mm" value="{{ settings.margin_tb_mm }}"></div>
        <div class="col-6"><label class="form-label">Margini sx/dx (mm)</label><input type="number" step="0.1" class="form-control" name="margin_lr_mm" value="{{ settings.margin_lr_mm }}"></div>
        <div class="col-6"><label class="form-label">Spazio tra etichette (mm)</label><input type="number" step="0.1" class="form-control" name="gap_mm" value="{{ settings.gap_mm }}"></div>
        <div class="col-6"><label class="form-label">Padding interno (mm)</label><input type="number" step="0.1" class="form-control" name="label_padding_mm" value="{{ settings.label_padding_mm }}"></div>
        <div class="col-6"><label class="form-label">Dimensione QR (mm)</label><input type="number" step="0.1" class="form-control" name="label_qr_size_mm" value="{{ settings.label_qr_size_mm }}"></div>
        <div class="col-6"><label class="form-label">Margine QR (mm)</label><input type="number" step="0.1" class="form-control" name="label_qr_margin_mm" value="{{ settings.label_qr_margin_mm }}"></div>
        <div class="col-6"><label class="form-label">Larghezza blocco posizione (mm)</label><input type="number" step="0.1" class="form-control" name="label_position_width_mm" value="{{ settings.label_position_width_mm }}"></div>
        <div class="col-6"><label class="form-label">Dimensione testo posizione (pt)</label><input type="number" step="0.1" class="form-control" name="label_position_font_pt" value="{{ settings.label_position_font_pt }}"></div>
        <div class="col-6"><label class="form-label">Cartellini: larghezza (mm)</label><input type="number" step="0.1" class="form-control" name="card_w_mm" value="{{ settings.card_w_mm }}"></div>
        <div class="col-6"><label class="form-label">Cartellini: altezza (mm)</label><input type="number" step="0.1" class="form-control" name="card_h_mm" value="{{ settings.card_h_mm }}"></div>
        <div class="col-6">
          <label class="form-label">Orientamento</label>
          <select class="form-select" name="orientation_landscape">
            <option value="1" {{ 'selected' if settings.orientation_landscape else '' }}>Orizzontale</option>
            <option value=""  {{ '' if settings.orientation_landscape else 'selected' }}>Verticale</option>
          </select>
        </div>
        <div class="col-6">
          <label class="form-label">QR attivo di default</label>
          <select class="form-select" name="qr_default">
            <option value="1" {{ 'selected' if settings.qr_default else '' }}>Sì</option>
            <option value="">No</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label">QR Base URL (opz.)</label>
          <input class="form-control" name="qr_base_url" placeholder="https://magazzino.local" value="{{ settings.qr_base_url or '' }}">
          <small class="text-muted">Se vuoto, uso l'host corrente.</small>
        </div>
        <div class="col-12 text-end mt-2"><button class="btn btn-primary">Salva impostazioni</button></div>
      </form>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section" id="mqtt">
      <h5>MQTT</h5>
      <form method="post" action="{{ url_for('update_mqtt_settings') }}" class="row g-2">
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="enabled" id="mqtt_enabled" {{ 'checked' if mqtt_settings.enabled else '' }}>
            <label class="form-check-label" for="mqtt_enabled">Abilita pubblicazione MQTT</label>
          </div>
        </div>
        <div class="col-md-6">
          <label class="form-label">Host</label>
          <input class="form-control" name="host" placeholder="broker.local" value="{{ mqtt_settings.host or '' }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">Porta</label>
          <input type="number" min="1" max="65535" class="form-control" name="port" value="{{ mqtt_settings.port }}">
        </div>
        <div class="col-md-3">
          <label class="form-label">QoS</label>
          <select class="form-select" name="qos">
            <option value="0" {{ 'selected' if mqtt_settings.qos == 0 else '' }}>0</option>
            <option value="1" {{ 'selected' if mqtt_settings.qos == 1 else '' }}>1</option>
            <option value="2" {{ 'selected' if mqtt_settings.qos == 2 else '' }}>2</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Topic</label>
          <input class="form-control" name="topic" placeholder="magazzino/slot" value="{{ mqtt_settings.topic or '' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">Client ID (opz.)</label>
          <input class="form-control" name="client_id" placeholder="magazzino-ui" value="{{ mqtt_settings.client_id or '' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">Username (opz.)</label>
          <input class="form-control" name="username" value="{{ mqtt_settings.username or '' }}">
        </div>
        <div class="col-md-6">
          <label class="form-label">Password (opz.)</label>
          <input type="password" class="form-control" name="password" placeholder="Lascia vuoto per non cambiare">
        </div>
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="clear_password" id="mqtt_clear_password">
            <label class="form-check-label" for="mqtt_clear_password">Cancella password salvata</label>
          </div>
        </div>
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="retain" id="mqtt_retain" {{ 'checked' if mqtt_settings.retain else '' }}>
            <label class="form-check-label" for="mqtt_retain">Messaggio retain</label>
          </div>
        </div>

        <div class="col-12 mt-3">
          <h6 class="mb-2">Cosa pubblicare</h6>
        </div>
        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_cabinet_name" id="mqtt_include_cabinet_name" {{ 'checked' if mqtt_settings.include_cabinet_name else '' }}>
            <label class="form-check-label" for="mqtt_include_cabinet_name">Nome cassettiera</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_cabinet_id" id="mqtt_include_cabinet_id" {{ 'checked' if mqtt_settings.include_cabinet_id else '' }}>
            <label class="form-check-label" for="mqtt_include_cabinet_id">ID cassettiera</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_location_name" id="mqtt_include_location_name" {{ 'checked' if mqtt_settings.include_location_name else '' }}>
            <label class="form-check-label" for="mqtt_include_location_name">Nome ubicazione</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_location_id" id="mqtt_include_location_id" {{ 'checked' if mqtt_settings.include_location_id else '' }}>
            <label class="form-check-label" for="mqtt_include_location_id">ID ubicazione</label>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_row" id="mqtt_include_row" {{ 'checked' if mqtt_settings.include_row else '' }}>
            <label class="form-check-label" for="mqtt_include_row">Riga selezionata</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_col" id="mqtt_include_col" {{ 'checked' if mqtt_settings.include_col else '' }}>
            <label class="form-check-label" for="mqtt_include_col">Colonna selezionata</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_slot_label" id="mqtt_include_slot_label" {{ 'checked' if mqtt_settings.include_slot_label else '' }}>
            <label class="form-check-label" for="mqtt_include_slot_label">Etichetta cella (es. A1)</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_empty" id="mqtt_include_empty" {{ 'checked' if mqtt_settings.include_empty else '' }}>
            <label class="form-check-label" for="mqtt_include_empty">Pubblica anche se la cella è vuota</label>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_items" id="mqtt_include_items" {{ 'checked' if mqtt_settings.include_items else '' }}>
            <label class="form-check-label" for="mqtt_include_items">Lista articoli nella cella</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_item_id" id="mqtt_include_item_id" {{ 'checked' if mqtt_settings.include_item_id else '' }}>
            <label class="form-check-label" for="mqtt_include_item_id">ID articolo</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_item_name" id="mqtt_include_item_name" {{ 'checked' if mqtt_settings.include_item_name else '' }}>
            <label class="form-check-label" for="mqtt_include_item_name">Nome articolo</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_item_category" id="mqtt_include_item_category" {{ 'checked' if mqtt_settings.include_item_category else '' }}>
            <label class="form-check-label" for="mqtt_include_item_category">Categoria</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_item_category_color" id="mqtt_include_item_category_color" {{ 'checked' if mqtt_settings.include_item_category_color else '' }}>
            <label class="form-check-label" for="mqtt_include_item_category_color">Colore categoria</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_item_quantity" id="mqtt_include_item_quantity" {{ 'checked' if mqtt_settings.include_item_quantity else '' }}>
            <label class="form-check-label" for="mqtt_include_item_quantity">Quantità</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_item_position" id="mqtt_include_item_position" {{ 'checked' if mqtt_settings.include_item_position else '' }}>
            <label class="form-check-label" for="mqtt_include_item_position">Posizione articolo</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_item_description" id="mqtt_include_item_description" {{ 'checked' if mqtt_settings.include_item_description else '' }}>
            <label class="form-check-label" for="mqtt_include_item_description">Descrizione articolo</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_item_material" id="mqtt_include_item_material" {{ 'checked' if mqtt_settings.include_item_material else '' }}>
            <label class="form-check-label" for="mqtt_include_item_material">Materiale articolo</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="include_item_finish" id="mqtt_include_item_finish" {{ 'checked' if mqtt_settings.include_item_finish else '' }}>
            <label class="form-check-label" for="mqtt_include_item_finish">Finitura articolo</label>
          </div>
        </div>

        <div class="col-12 text-end mt-2">
          <button class="btn btn-primary">Salva configurazione MQTT</button>
        </div>
      </form>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section" id="campi-personalizzati">
      <h5>Campi personalizzati</h5>
      <form method="post" action="{{ url_for('add_custom_field') }}" class="row g-2 mb-3">
        <div class="col-md-6">
          <label class="form-label">Nome</label>
          <input class="form-control" name="name" placeholder="Es. Classe" required>
        </div>
        <div class="col-md-6">
          <label class="form-label">Tipo</label>
          <select class="form-select" name="field_type">
            <option value="text">Testo</option>
            <option value="number">Numero</option>
            <option value="select">Selezione</option>
          </select>
        </div>
        <div class="col-md-6">
          <label class="form-label">Unità (opz.)</label>
          <input class="form-control" name="unit" placeholder="mm, V, ...">
        </div>
        <div class="col-md-6">
          <label class="form-label">Ordine</label>
          <input type="number" class="form-control" name="sort_order" value="0">
        </div>
        <div class="col-12">
          <label class="form-label">Opzioni (solo per selezione)</label>
          <textarea class="form-control" name="options" rows="2" placeholder="Una per riga"></textarea>
        </div>
        <div class="col-12">
          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_active" id="is_active_new" checked>
            <label class="form-check-label" for="is_active_new">Attivo</label>
          </div>
        </div>
        <div class="col-12 text-end">
          <button class="btn btn-primary">Aggiungi campo</button>
        </div>
      </form>

      <div class="table-responsive">
        <table class="table table-sm align-middle">
          <thead>
            <tr>
              <th>Campo</th>
              <th style="width:110px;">Azioni</th>
            </tr>
          </thead>
          <tbody>
            {% for field in custom_fields %}
            <tr>
              <td>
                <form method="post" action="{{ url_for('update_custom_field', field_id=field.id) }}" class="row g-2">
                  <div class="col-md-6">
                    <input class="form-control" name="name" value="{{ field.name }}">
                  </div>
                  <div class="col-md-3">
                    <select class="form-select" name="field_type">
                      <option value="text" {{ 'selected' if field.field_type == 'text' else '' }}>Testo</option>
                      <option value="number" {{ 'selected' if field.field_type == 'number' else '' }}>Numero</option>
                      <option value="select" {{ 'selected' if field.field_type == 'select' else '' }}>Selezione</option>
                    </select>
                  </div>
                  <div class="col-md-3">
                    <input class="form-control" name="unit" placeholder="Unità" value="{{ field.unit or '' }}">
                  </div>
                  <div class="col-md-3">
                    <input type="number" class="form-control" name="sort_order" value="{{ field.sort_order }}">
                  </div>
                  <div class="col-md-6">
                    <textarea class="form-control" name="options" rows="2" placeholder="Opzioni">{{ field.options | join('\n') }}</textarea>
                  </div>
                  <div class="col-md-3">
                    <div class="form-check mt-2">
                      <input class="form-check-input" type="checkbox" name="is_active" id="field-active-{{ field.id }}" {{ 'checked' if field.is_active else '' }}>
                      <label class="form-check-label" for="field-active-{{ field.id }}">Attivo</label>
                    </div>
                  </div>
                  <div class="col-md-3 text-end">
                    <button class="btn btn-sm btn-primary w-100">Salva</button>
                  </div>
                </form>
              </td>
              <td class="text-end">
                <form method="post" action="{{ url_for('delete_custom_field', field_id=field.id) }}" onsubmit="return confirm('Eliminare il campo personalizzato?')">
                  <button class="btn btn-sm btn-outline-danger w-100">Elimina</button>
                </form>
              </td>
            </tr>
            {% else %}
            <tr><td colspan="2" class="text-muted">Nessun campo personalizzato.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section" id="ubicazioni">
      <h5>Ubicazioni</h5>
      <form method="post" action="{{ url_for('add_location') }}" class="row g-2 mb-2">
        <div class="col-md-9"><input class="form-control" name="name" placeholder="Nome ubicazione"></div>
        <div class="col-md-3"><button class="btn btn-primary w-100">Aggiungi</button></div>
      </form>
      <table class="table table-sm table-striped">
        <thead><tr><th>ID</th><th>Nome</th><th>Azione</th></tr></thead>
        <tbody>
          {% for l in locations %}
          <tr>
            <td>{{ l.id }}</td>
            <td>
              <form method="post" action="{{ url_for('update_location', loc_id=l.id) }}" class="row g-2">
                <div class="col-md-9"><input class="form-control" name="name" value="{{ l.name }}"></div>
                <div class="col-md-3">
                  <button class="btn btn-sm btn-primary">Salva</button>
                  <button formaction="{{ url_for('delete_location', loc_id=l.id) }}" formmethod="post" class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminare ubicazione?')">Elimina</button>
                </div>
              </form>
            </td>
            <td></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section" id="cassettiere">
      <h5>Cassettiere</h5>
      <form method="post" action="{{ url_for('add_cabinet') }}" class="row g-2 mb-2">
        <div class="col-md-4">
          <label class="form-label small text-muted mb-1">Ubicazione</label>
          <select class="form-select" name="location_id" required>
            {% for l in locations %}
              <option value="{{ l.id }}">{{ l.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label small text-muted mb-1">Nome</label>
          <input class="form-control" name="name" placeholder="Nome cassettiera">
        </div>
        <div class="col-md-2">
          <label class="form-label small text-muted mb-1">Righe</label>
          <input type="number" min="1" max="128" class="form-control" name="rows_max" value="128">
        </div>
        <div class="col-md-1">
          <label class="form-label small text-muted mb-1">Colonne</label>
          <input class="form-control" name="cols_max" placeholder="ZZ" value="ZZ" maxlength="2">
        </div>
        <div class="col-md-1">
          <label class="form-label small text-muted mb-1">Comp.</label>
          <input type="number" min="1" class="form-control" name="compartments_per_slot" value="6">
        </div>
        <div class="col-md-12 text-end"><button class="btn btn-primary">Aggiungi</button></div>
      </form>

      <table class="table table-striped">
        <thead><tr><th>ID</th><th>Ubicazione</th><th>Nome</th><th>Righe</th><th>Colonne</th><th>Comp.</th><th>Azione</th></tr></thead>
        <tbody>
          {% for c,l in cabinets %}
          <tr>
            <td>{{ c.id }}</td>
            <td>{{ l.name }}</td>
            <td>
              <input class="form-control" name="name" value="{{ c.name }}" form="cabinet-form-{{ c.id }}">
            </td>
            <td>
              <input type="number" min="1" max="128" class="form-control" name="rows_max" value="{{ c.rows_max }}" form="cabinet-form-{{ c.id }}">
            </td>
            <td>
              <input class="form-control" name="cols_max" value="{{ c.cols_max }}" maxlength="2" form="cabinet-form-{{ c.id }}">
            </td>
            <td>
              <input type="number" min="1" class="form-control" name="compartments_per_slot" value="{{ c.compartments_per_slot }}" form="cabinet-form-{{ c.id }}">
            </td>
            <td class="text-end">
              <form method="post" action="{{ url_for('update_cabinet', cab_id=c.id) }}" id="cabinet-form-{{ c.id }}" class="d-grid gap-1"></form>
              <div class="d-grid gap-1">
                <button class="btn btn-sm btn-primary" form="cabinet-form-{{ c.id }}">Salva</button>
                <button formaction="{{ url_for('delete_cabinet', cab_id=c.id) }}" formmethod="post" class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminare cassettiera?')" form="cabinet-form-{{ c.id }}">Elimina</button>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section" id="fusione-cassetti">
      <h5>Fusione cassetti</h5>
      <form method="post" action="{{ url_for('add_drawer_merge') }}" class="row g-2 mb-2">
        <div class="col-md-4">
          <select class="form-select" name="cabinet_id" required>
            {% for c,l in cabinets %}
              <option value="{{ c.id }}">{{ c.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-md-2"><input class="form-control" name="col_start" placeholder="Col. da (es. A)" required></div>
        <div class="col-md-2"><input type="number" min="1" max="128" class="form-control" name="row_start" placeholder="Riga da" required></div>
        <div class="col-md-2"><input class="form-control" name="col_end" placeholder="Col. a (es. C)" required></div>
        <div class="col-md-2"><input type="number" min="1" max="128" class="form-control" name="row_end" placeholder="Riga a" required></div>
        <div class="col-md-12 text-end"><button class="btn btn-primary">Aggiungi fusione</button></div>
      </form>
      <div class="form-text mb-2">Le celle adiacenti selezionate saranno visualizzate come un unico cassetto.</div>
      <table class="table table-striped">
        <thead><tr><th>Cassettiera</th><th>Da</th><th>A</th><th>Azione</th></tr></thead>
        <tbody>
          {% for m,c in drawer_merges %}
          <tr>
            <td>{{ c.name }}</td>
            <td>{{ m.col_start }}{{ m.row_start }}</td>
            <td>{{ m.col_end }}{{ m.row_end }}</td>
            <td>
              <form method="post" action="{{ url_for('delete_drawer_merge', merge_id=m.id) }}">
                <button class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminare fusione?')">Elimina</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="text-muted">Nessuna fusione configurata.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section" id="sposta-cassetti">
      <h5>Sposta / Scambia cassetti</h5>
      <form method="post" action="{{ url_for('move_slot') }}" class="row g-2">
        <div class="col-md-3">
          <label class="form-label">Origine</label>
          <select class="form-select" name="cabinet_from">
            {% for c,l in cabinets %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2"><label class="form-label">Col</label><input class="form-control" name="col_from"></div>
        <div class="col-md-2"><label class="form-label">Riga</label><input type="number" class="form-control" name="row_from"></div>

        <div class="col-md-3">
          <label class="form-label">Destinazione</label>
          <select class="form-select" name="cabinet_to">
            {% for c,l in cabinets %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
          </select>
        </div>
        <div class="col-md-2"><label class="form-label">Col</label><input class="form-control" name="col_to"></div>
        <div class="col-md-2"><label class="form-label">Riga</label><input type="number" class="form-control" name="row_to"></div>

        <div class="col-md-2"><label class="form-label"> </label><div class="form-check"><input class="form-check-input" type="checkbox" name="swap" id="swap"> <label class="form-check-label" for="swap">Scambia</label></div></div>
        <div class="col-md-2 align-self-end"><button class="btn btn-primary w-100">Esegui</button></div>
      </form>
    </div>
  </div>
  {% endif %}

  {% if can_manage_users %}
  <div class="col-12">
    <div class="form-section" id="utenti">
      <h5>Utenti</h5>
      <p class="text-muted mb-2 small">Assegna un ruolo agli utenti registrati.</p>
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr><th style="width:60px;">ID</th><th>Username</th><th style="width:280px;">Ruolo</th><th class="text-end" style="width:120px;">Azione</th></tr>
        </thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ u.id }}</td>
            <td>{{ u.username }}</td>
            <td>
              <select class="form-select" name="role_id" form="user-role-{{ u.id }}">
                {% for r in roles %}
                  <option value="{{ r.id }}" {{ 'selected' if u.role_id == r.id else '' }}>{{ r.name }}</option>
                {% endfor %}
              </select>
            </td>
            <td class="text-end">
              <form method="post" action="{{ url_for('update_user_role', user_id=u.id) }}" id="user-role-{{ u.id }}">
                <button class="btn btn-sm btn-primary">Salva</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% endif %}

  {% if can_manage_roles %}
  <div class="col-12">
    <div class="form-section" id="ruoli">
      <h5>Ruoli</h5>
      <p class="text-muted mb-2 small">Definisci i ruoli e le funzioni abilitate per ciascun ruolo.</p>
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr><th style="width:60px;">ID</th><th>Nome</th><th>Descrizione</th><th>Permessi</th><th class="text-end" style="width:160px;">Azione</th></tr>
        </thead>
        <tbody>
          {% for r in roles %}
          <tr>
            <td>{{ r.id }}</td>
            <td><input class="form-control" name="name" value="{{ r.name }}" form="role-{{ r.id }}"></td>
            <td><input class="form-control" name="description" value="{{ r.description or '' }}" form="role-{{ r.id }}"></td>
            <td>
              <div class="d-flex flex-wrap gap-2">
                {% for p in permissions %}
                  <label class="form-check form-check-inline mb-0 small">
                    <input class="form-check-input" type="checkbox" name="permission_keys" value="{{ p.key }}" form="role-{{ r.id }}" {{ 'checked' if p in r.permissions else '' }}>
                    <span class="form-check-label">{{ p.label }}</span>
                  </label>
                {% endfor %}
              </div>
            </td>
            <td class="text-end">
              <form method="post" action="{{ url_for('update_role', role_id=r.id) }}" id="role-{{ r.id }}" class="d-inline-block">
                <button class="btn btn-sm btn-primary">Salva</button>
              </form>
              {% if not r.is_system %}
                <form method="post" action="{{ url_for('delete_role', role_id=r.id) }}" class="d-inline-block" onsubmit="return confirm('Eliminare il ruolo?')">
                  <button class="btn btn-sm btn-outline-danger ms-1">Elimina</button>
                </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="pt-2 border-top mt-2">
        <h6 class="mb-2">Nuovo ruolo</h6>
        <form method="post" action="{{ url_for('add_role') }}" class="row g-2 align-items-center">
          <div class="col-md-4"><input class="form-control" name="name" placeholder="Nome ruolo"></div>
          <div class="col-md-6"><input class="form-control" name="description" placeholder="Descrizione (opzionale)"></div>
          <div class="col-md-2"><button class="btn btn-primary w-100">Aggiungi</button></div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="form-section" id="permessi">
      <h5>Permessi (funzioni)</h5>
      <p class="text-muted mb-2 small">Crea nuove funzioni da associare ai ruoli.</p>
      <table class="table table-sm table-striped align-middle">
        <thead>
          <tr><th style="width:60px;">ID</th><th>Chiave</th><th>Etichetta</th><th>Descrizione</th><th style="width:120px;">Tipo</th></tr>
        </thead>
        <tbody>
          {% for p in permissions %}
          <tr>
            <td>{{ p.id }}</td>
            <td><code>{{ p.key }}</code></td>
            <td>{{ p.label }}</td>
            <td>{{ p.description or '' }}</td>
            <td><span class="badge {{ 'bg-secondary' if p.is_system else 'bg-info' }}">{{ 'Sistema' if p.is_system else 'Custom' }}</span></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>

      <div class="pt-2 border-top mt-2">
        <h6 class="mb-2">Nuovo permesso</h6>
        <form method="post" action="{{ url_for('add_permission') }}" class="row g-2 align-items-center">
          <div class="col-md-3"><input class="form-control" name="key" placeholder="chiave_permesso"></div>
          <div class="col-md-4"><input class="form-control" name="label" placeholder="Etichetta"></div>
          <div class="col-md-4"><input class="form-control" name="description" placeholder="Descrizione (opzionale)"></div>
          <div class="col-md-1"><button class="btn btn-primary w-100">Aggiungi</button></div>
        </form>
      </div>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}
