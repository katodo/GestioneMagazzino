{% extends "base.html" %}
{% block content %}
<h3>Categorie, sottotipi, materiali e finiture</h3>

<div class="row">
  <div class="col-lg-12">
    <div class="form-section">
      <h5 class="mb-2">Categorie</h5>
      <table class="table table-striped" id="tblCats">
        <thead>
          <tr><th>ID</th><th>Nome</th><th>Colore</th><th>Azione</th></tr>
        </thead>
        <tbody>
          {% for c in categories %}
          <tr>
            <td>{{ c.id }}</td>
            <td>
              <form method="post" action="{{ url_for('update_category', cat_id=c.id) }}" class="row g-2 align-items-center">
                <div class="col-md-5">
                  <input class="form-control" name="name" value="{{ c.name }}">
                </div>
                <div class="col-md-3">
                  <input type="color" class="form-control form-control-color" name="color" value="{{ c.color }}">
                </div>
                <div class="col-md-4">
                  <button class="btn btn-sm btn-primary">Salva</button>
                  <button formaction="{{ url_for('delete_category', cat_id=c.id) }}" formmethod="post" class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminare categoria?')">Elimina</button>
                </div>
              </form>
            </td>
            <td><span class="badge-color" style="background:{{ c.color }}"></span>{{ c.color }}</td>
            <td></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <div class="col-lg-12">
    <div class="form-section">
      <h5 class="mb-2">Nuova categoria</h5>
      <form method="post" action="{{ url_for('add_category') }}" class="row g-2">
        <div class="col-md-6">
          <input class="form-control" name="name" placeholder="Nome categoria">
        </div>
        <div class="col-md-3">
          <input type="color" class="form-control form-control-color" name="color" value="#607D8B">
        </div>
        <div class="col-md-3">
          <button class="btn btn-primary w-100">Aggiungi</button>
        </div>
      </form>
    </div>
  </div>
</div>

<hr class="my-3">

<div class="form-section mb-3">
  <h5 class="mb-2">Sottotipi (forme)</h5>

  <form method="post" action="{{ url_for('add_subtype') }}" class="row g-2 mb-2">
    <div class="col-md-4">
      <select class="form-select" name="category_id" required>
        <option value="">Categoria...</option>
        {% for c in categories %}
          <option value="{{ c.id }}">{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-5">
      <input class="form-control" name="name" placeholder="Nome sottotipo (es. Testa cilindrica)">
    </div>
    <div class="col-md-3">
      <button class="btn btn-primary w-100">Aggiungi</button>
    </div>
  </form>

  <table class="table table-sm table-striped" id="tblSubtypes">
    <thead>
      <tr><th>ID</th><th>Categoria</th><th>Nome</th><th>Azione</th></tr>
    </thead>
    <tbody>
      {% for st, c in subtypes %}
      <tr>
        <td>{{ st.id }}</td>
        <td colspan="3">
          <form method="post" action="{{ url_for('update_subtype', st_id=st.id) }}" class="row g-2 align-items-center">
            <div class="col-md-4">
              <select class="form-select" name="category_id">
                {% for cat in categories %}
                  <option value="{{ cat.id }}" {{ 'selected' if cat.id == st.category_id else '' }}>{{ cat.name }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <input class="form-control" name="name" value="{{ st.name }}">
            </div>
            <div class="col-md-4">
              <button class="btn btn-sm btn-primary">Salva</button>
              {% if st.id in used_subtypes %}
                <button class="btn btn-sm btn-outline-secondary" type="button" disabled title="Sottotipo in uso">Elimina</button>
              {% else %}
                <button formaction="{{ url_for('delete_subtype', st_id=st.id) }}" formmethod="post" class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminare sottotipo?')">Elimina</button>
              {% endif %}
            </div>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<div class="row">
  <div class="col-lg-12">
    <div class="form-section mb-3">
      <h5 class="mb-2">Materiali</h5>
      <table class="table table-striped" id="tblMaterials">
        <thead>
          <tr><th>ID</th><th>Nome</th><th>Azione</th></tr>
        </thead>
        <tbody>
          {% for m in materials %}
          <tr>
            <td>{{ m.id }}</td>
            <td>
              <form method="post" action="{{ url_for('update_material', mat_id=m.id) }}" class="row g-2 align-items-center">
                <div class="col-md-8">
                  <input class="form-control" name="name" value="{{ m.name }}">
                </div>
                <div class="col-md-4">
                  <button class="btn btn-sm btn-primary">Salva</button>
                  {% if m.id in used_materials %}
                    <button class="btn btn-sm btn-outline-secondary" type="button" disabled title="Materiale in uso">Elimina</button>
                  {% else %}
                    <button formaction="{{ url_for('delete_material', mat_id=m.id) }}" formmethod="post" class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminare materiale?')">Elimina</button>
                  {% endif %}
                </div>
              </form>
            </td>
            <td></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="form-section">
      <h5 class="mb-2">Nuovo materiale</h5>
      <form method="post" action="{{ url_for('add_material') }}" class="row g-2">
        <div class="col-md-8">
          <input class="form-control" name="name" placeholder="Descrizione materiale">
        </div>
        <div class="col-md-4">
          <button class="btn btn-primary w-100">Aggiungi</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="row mt-3">
  <div class="col-lg-6">
    <div class="form-section mb-3">
      <h5 class="mb-2">Finiture</h5>
      <table class="table table-striped" id="tblFinishes">
        <thead>
          <tr><th>ID</th><th>Nome</th><th>Azione</th></tr>
        </thead>
        <tbody>
          {% for f in finishes %}
          <tr>
            <td>{{ f.id }}</td>
            <td>
              <form method="post" action="{{ url_for('update_finish', fin_id=f.id) }}" class="row g-2 align-items-center">
                <div class="col-md-8">
                  <input class="form-control" name="name" value="{{ f.name }}">
                </div>
                <div class="col-md-4">
                  <button class="btn btn-sm btn-primary">Salva</button>
                  {% if f.id in used_finishes %}
                    <button class="btn btn-sm btn-outline-secondary" type="button" disabled title="Finitura in uso">Elimina</button>
                  {% else %}
                    <button formaction="{{ url_for('delete_finish', fin_id=f.id) }}" formmethod="post" class="btn btn-sm btn-outline-danger" onclick="return confirm('Eliminare finitura?')">Elimina</button>
                  {% endif %}
                </div>
              </form>
            </td>
            <td></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div class="form-section">
      <h5 class="mb-2">Nuova finitura</h5>
      <form method="post" action="{{ url_for('add_finish') }}" class="row g-2">
        <div class="col-md-8">
          <input class="form-control" name="name" placeholder="Descrizione finitura">
        </div>
        <div class="col-md-4">
          <button class="btn btn-primary w-100">Aggiungi</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
$(function(){
  if ($.fn.DataTable) {
    $('#tblCats').DataTable({pageLength:50, order:[[0,'asc']]});
    $('#tblSubtypes').DataTable({pageLength:50, order:[[0,'asc']]});
    $('#tblMaterials').DataTable({pageLength:50, order:[[0,'asc']]});
    $('#tblFinishes').DataTable({pageLength:50, order:[[0,'asc']]});
  }
});
</script>
{% endblock %}
