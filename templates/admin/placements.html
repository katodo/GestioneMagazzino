{% extends "base.html" %}
{% block content %}
<h3>Posizionamento articoli</h3>

<div class="form-section mb-3">
  <form method="post" id="autoAssignForm" action="{{ url_for('placements') }}">
    <input type="hidden" name="action" id="formAction" value="auto_assign">
    <div class="row g-2">
      <div class="col-md-3">
        <label class="form-label">Cassettiera</label>
        <select name="cabinet_id" class="form-select" required>
          {% for c in cabinets %}
            <option value="{{ c.id }}" {{ 'selected' if c.id == form_cabinet_id else '' }}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Categoria</label>
        <select name="category_id" class="form-select" id="categorySelect" required>
          {% for c in categories %}
            <option value="{{ c.id }}" data-unplaced="{{ unplaced_by_category.get(c.id, 0) }}" {{ 'selected' if c.id == form_category_id else '' }}>{{ c.name }}</option>
          {% endfor %}
        </select>
        <div class="form-text">Articoli non posizionati: <span id="unplacedCount">{{ unplaced_count if unplaced_count is not none else '' }}</span></div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Chiave primaria</label>
        <select name="primary_key" class="form-select">
          {% for v, label in sort_options %}
            <option value="{{ v }}" {{ 'selected' if v == primary_key else '' }}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Chiave secondaria</label>
        <select name="secondary_key" class="form-select">
          <option value="">(nessuna)</option>
          {% for v, label in sort_options %}
            <option value="{{ v }}" {{ 'selected' if v == secondary_key else '' }}>{{ label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Numero di articoli</label>
        <input type="number" min="1" class="form-control" id="countInput" name="count" value="{{ count or 10 }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Direzione</label>
        <select name="direction" class="form-select">
          <option value="H" {{ 'selected' if direction == 'H' else '' }}>Orizzontale</option>
          <option value="V" {{ 'selected' if direction == 'V' else '' }}>Verticale</option>
        </select>
        <div class="form-text">Orizzontale: da sinistra a destra, poi riga successiva. Verticale: dall'alto in basso, poi colonna successiva.</div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Cella di partenza</label>
        <div class="input-group">
          <span class="input-group-text">Col</span>
          <input type="text" class="form-control" name="start_col" id="start_col" value="{{ start_col or '' }}" maxlength="2" placeholder="es. A">
          <span class="input-group-text">Riga</span>
          <input type="number" class="form-control" name="start_row" id="start_row" value="{{ start_row or '' }}" min="1" max="128">
        </div>
        <div class="form-text">Puoi anche cliccare una cella nella griglia qui sotto.</div>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="1" id="clear_occupied" name="clear_occupied" {{ 'checked' if clear_occupied else '' }}>
          <label class="form-check-label" for="clear_occupied">
            De-alloca celle già popolate nel percorso
          </label>
        </div>
      </div>
      <div class="col-12 d-flex justify-content-between align-items-center">
        <div class="text-muted small">La de-allocazione di una categoria comporta la ristampa di tutte le etichette e il riposizionamento dei cassetti.</div>
        <div class="text-end">
          <button type="button" class="btn btn-outline-danger me-2" id="clearCategoryBtn">De-alloca intera categoria</button>
          <button class="btn btn-primary">Assegna automaticamente</button>
        </div>
      </div>
    </div>
  </form>
</div>

<h4>Griglia cassettiera</h4>
<div class="legend mb-2">
  <span style="background:black"></span> Bloccata
  {% for c in categories %}
    <span style="background:{{ c.color }}; margin-left:12px;"></span> {{ c.name }}
  {% endfor %}
</div>

<div class="grid-wrap p-2">
  {% if grid.rows and grid.cols %}
  <table class="grid-table table table-sm mb-0" id="autoGrid">
    <thead>
      <tr>
        <th class="rowhdr"></th>
        {% for col in grid.cols %}
          <th>{{ col }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for r in grid.rows %}
      <tr>
        <th class="rowhdr">{{ r }}</th>
        {% for col in grid.cols %}
          {% set key = col ~ '-' ~ r %}
          {% if grid.merge_skips and grid.merge_skips.get(key) %}
          {% else %}
            {% set cell = grid.cells.get(key) %}
            {% set merge = grid.merge_anchors.get(key) if grid.merge_anchors else None %}
            {% if not cell %}
              <td class="cell-empty" data-col="{{ col }}" data-row="{{ r }}" data-cat="">
                <div class="cell-inner" style="color:#777; text-shadow:none; font-weight:500;">&nbsp;</div>
              </td>
            {% else %}
              {% if cell.blocked %}
                <td class="cell-blocked" data-col="{{ col }}" data-row="{{ r }}" data-cat="blocked" {% if merge %}rowspan="{{ merge.rowspan }}" colspan="{{ merge.colspan }}"{% endif %}>
                  <div class="cell-inner">&nbsp;</div>
                </td>
              {% else %}
                {% set bg = cell.entries[0].color if cell.entries else '#6c757d' %}
                <td class="cell-used" data-col="{{ col }}" data-row="{{ r }}" data-cat="{{ cell.cat_id or '' }}" data-items='{{ cell.entries|tojson }}' style="background:{{ bg }}" {% if merge %}rowspan="{{ merge.rowspan }}" colspan="{{ merge.colspan }}"{% endif %}>
                  <div class="cell-inner">
                    {% for e in cell.entries %}
                      <div class="cell-line">{{ e.text }}</div>
                    {% endfor %}
                  </div>
                </td>
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <div class="text-muted p-3">Nessuna cassettiera selezionata.</div>
  {% endif %}
</div>

<div class="form-section mt-3">
  <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
    <h5 class="mb-0">Articoli da posizionare</h5>
    <a href="{{ url_for('cassettiere') }}" class="btn btn-outline-secondary btn-sm">Vai alla griglia</a>
  </div>
  <div class="table-responsive table-sticky">
    <table class="table table-striped align-middle mb-0" id="tbl">
      <thead><tr><th>ID</th><th>Categoria</th><th>Descrizione</th><th>Misura</th><th>Azioni</th></tr></thead>
      <tbody>
        {% for it in items_to_place %}
        <tr>
          <td>{{ it.id }}</td>
          <td>{% if it.category %}<span class="badge-color" style="background:{{ it.category.color }}"></span>{{ it.category.name }}{% endif %}</td>
          <td>{{ compose_caption(it) }}</td>
          <td>{{ it.thread_size or '' }}</td>
          <td class="text-nowrap">
            <a href="{{ url_for('edit_item', item_id=it.id) }}" class="btn btn-sm btn-outline-primary">Modifica</a>
            <a href="{{ url_for('cassettiere') }}" class="btn btn-sm btn-outline-secondary">Apri griglia</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  function escapeHtml(str){
    return (str || '').replace(/[&<>"']/g, function(m) {
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m] || m);
    });
  }
  function initCellPopovers(gridId){
    const grid = document.getElementById(gridId);
    if (!grid || typeof bootstrap === 'undefined') return;
    grid.querySelectorAll('td.cell-used').forEach(td=>{
      const raw = td.dataset.items;
      if (!raw) return;
      let items = [];
      try { items = JSON.parse(raw); } catch { items = []; }
      if (!items.length) return;
      const content = items.map(it=>{
        const detailParts = [];
        if (it.thread_size) detailParts.push(it.thread_size);
        if (it.main_measure && it.main_measure.value) detailParts.push(`${it.main_measure.label}: ${it.main_measure.value}`);
        if (it.quantity !== null && it.quantity !== undefined) detailParts.push(`Q.ta ${it.quantity}`);
        if (it.share_drawer) detailParts.push('Condividi cassetto');
        return `
          <div class="d-flex align-items-start mb-1">
            <span class="badge-color flex-shrink-0 mt-1" style="background:${it.color || '#999'};"></span>
            <div class="ms-2">
              <div class="fw-semibold">${escapeHtml(it.name || it.text || '')}</div>
              ${it.description ? `<div class="small text-muted">${escapeHtml(it.description)}</div>` : ''}
              ${detailParts.length ? `<div class="small">${detailParts.map(escapeHtml).join(' - ')}</div>` : ''}
              ${it.position ? `<div class="small text-muted">Pos: ${escapeHtml(it.position)}</div>` : ''}
            </div>
          </div>`;
      }).join('');
      new bootstrap.Popover(td, {
        trigger:'hover focus',
        placement:'top',
        html:true,
        title:'Dettaglio cassetto',
        content: `<div class="popover-items">${content}</div>`
      });
    });
  }

  const categorySelect = document.getElementById('categorySelect');
  const countInput = document.getElementById('countInput');
  const unplacedCount = document.getElementById('unplacedCount');
  if (categorySelect && countInput) {
    categorySelect.addEventListener('change', function() {
      const selected = categorySelect.options[categorySelect.selectedIndex];
      const unplacedValue = selected ? selected.dataset.unplaced : '';
      if (unplacedValue !== undefined && unplacedValue !== '') {
        countInput.value = unplacedValue;
      }
      if (unplacedCount) {
        unplacedCount.textContent = unplacedValue ?? '';
      }
    });
  }
  const grid = document.getElementById('autoGrid');
  if (grid) {
    initCellPopovers('autoGrid');
    grid.addEventListener('click', function(e){
      const td = e.target.closest('td');
      if (!td) return;
      if (td.classList.contains('cell-blocked')) {
        alert('Cella bloccata, non utilizzabile.');
        return;
      }
      const col = td.dataset.col;
      const row = td.dataset.row;
      if (!col || !row) return;
      document.getElementById('start_col').value = col;
      document.getElementById('start_row').value = row;
      grid.querySelectorAll('td').forEach(c => c.classList.remove('table-primary'));
      td.classList.add('table-primary');
    });
  }

  const clearBtn = document.getElementById('clearCategoryBtn');
  if (clearBtn) {
    clearBtn.addEventListener('click', function(e){
      e.preventDefault();
      const form = document.getElementById('autoAssignForm');
      if (!form) return;
      const firstConfirm = confirm('Confermi di voler de-allocare TUTTA la categoria dalla cassettiera selezionata?');
      if (!firstConfirm) return;
      const secondConfirm = confirm('Operazione invasiva: sarà necessario ristampare tutte le etichette e riposizionare i cassetti. Procedere comunque?');
      if (!secondConfirm) return;
      document.getElementById('formAction').value = 'clear_category';
      form.submit();
    });
  }

  if ($.fn.DataTable) {
    $('#tbl').DataTable({
      pageLength:50,
      lengthMenu:[10, 25, 50, 100],
      order:[[1,'asc']],
      language: { search: "Cerca nella tabella:" }
    });
  }
});
</script>
{% endblock %}
