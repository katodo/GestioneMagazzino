{% extends "base.html" %}
{% set container_class = "container-fluid" %}
{% set container_extra_class = "grid-page" %}
{% block content %}
<h3>Posizionamento articoli</h3>

<div class="form-section mb-3">
  <form method="post" id="autoAssignForm" action="{{ url_for('placements') }}">
    <input type="hidden" name="action" id="formAction" value="auto_assign">
    <input type="hidden" name="clear_scope" id="clearScope" value="all">
    <div class="row g-2">
      <div class="col-md-3">
        <label class="form-label">Cassettiera</label>
        <select name="cabinet_id" class="form-select" required>
          {% for c in cabinets %}
            <option value="{{ c.id }}" {{ 'selected' if c.id == form_cabinet_id else '' }}>{{ c.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-3">
        <label class="form-label">Categoria</label>
        <select name="category_id" class="form-select" id="categorySelect" required>
          {% for c in categories %}
            <option value="{{ c.id }}" data-unplaced="{{ unplaced_by_category.get(c.id, 0) }}" {{ 'selected' if c.id == form_category_id else '' }}>{{ c.name }}</option>
          {% endfor %}
        </select>
        <div class="form-text">Articoli non posizionati: <span id="unplacedCount">{{ unplaced_count if unplaced_count is not none else '' }}</span></div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Numero di articoli</label>
        <input type="number" min="0" class="form-control" id="countInput" name="count" value="{{ count or 10 }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Direzione</label>
        <select name="direction" class="form-select">
          <option value="H" {{ 'selected' if direction == 'H' else '' }}>Orizzontale</option>
          <option value="V" {{ 'selected' if direction == 'V' else '' }}>Verticale</option>
        </select>
        <div class="form-text">Orizzontale: da sinistra a destra, poi riga successiva. Verticale: dall'alto in basso, poi colonna successiva.</div>
      </div>
      <div class="col-md-3">
        <label class="form-label">Cella di partenza</label>
        <div class="input-group">
          <span class="input-group-text">Col</span>
          <input type="text" class="form-control" name="start_col" id="start_col" value="{{ start_col or '' }}" maxlength="2" placeholder="es. A">
          <span class="input-group-text">Riga</span>
          <input type="number" class="form-control" name="start_row" id="start_row" value="{{ start_row or '' }}" min="1" max="128">
        </div>
        <div class="form-text">Puoi anche cliccare una cella nella griglia qui sotto.</div>
      </div>
      <div class="col-md-3 d-flex align-items-end">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" value="1" id="clear_occupied" name="clear_occupied" {{ 'checked' if clear_occupied else '' }}>
          <label class="form-check-label" for="clear_occupied">
            De-alloca celle già popolate nel percorso
          </label>
        </div>
      </div>
      <div class="col-12">
        <div class="border rounded-3 bg-light-subtle p-3">
          <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
            <div>
              <div class="fw-semibold">Chiavi di ordinamento</div>
              <div class="small text-muted">Definisci l'ordine di priorità dalla primaria alla quarta.</div>
            </div>
            <div class="small text-muted">Suggerimento: per le viti usa Misura → Sottotipo → Lunghezza → Materiale.</div>
          </div>
          <div class="row g-2 align-items-end">
            <div class="col-lg-3 col-md-6">
              <label class="form-label">Primaria</label>
              <select name="primary_key" class="form-select" id="primaryKeySelect">
                {% for v, label in sort_options %}
                  <option value="{{ v }}" {{ 'selected' if v == primary_key else '' }}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-3 col-md-6">
              <label class="form-label">Secondaria</label>
              <select name="secondary_key" class="form-select" id="secondaryKeySelect">
                <option value="">(nessuna)</option>
                {% for v, label in sort_options %}
                  <option value="{{ v }}" {{ 'selected' if v == secondary_key else '' }}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-3 col-md-6">
              <label class="form-label">Terza</label>
              <select name="tertiary_key" class="form-select" id="tertiaryKeySelect">
                <option value="">(nessuna)</option>
                {% for v, label in sort_options %}
                  <option value="{{ v }}" {{ 'selected' if v == tertiary_key else '' }}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-lg-3 col-md-6">
              <label class="form-label">Quarta</label>
              <select name="quaternary_key" class="form-select" id="quaternaryKeySelect">
                <option value="">(nessuna)</option>
                {% for v, label in sort_options %}
                  <option value="{{ v }}" {{ 'selected' if v == quaternary_key else '' }}>{{ label }}</option>
                {% endfor %}
              </select>
            </div>
          </div>
          <div class="mt-3">
            <div class="small text-muted mb-1">Anteprima ordinamento (esempio dinamico)</div>
            <div class="border rounded bg-white p-2">
              <ol class="mb-0 small" id="sortPreviewList"></ol>
            </div>
          </div>
        </div>
      </div>
      <div class="col-12">
        <div class="row g-3 align-items-start flex-wrap">
          <div class="col-lg">
            <div class="alert alert-light border small mb-0">
              <div class="fw-semibold mb-1">Come usare le de-allocazioni</div>
              <ul class="mb-0 ps-3">
                <li>Imposta colonna, riga, direzione e numero per "De-alloca area"; lascia i campi vuoti per agire su tutta la categoria.</li>
                <li>La de-allocazione di una categoria comporta la ristampa di tutte le etichette e il riposizionamento dei cassetti.</li>
              </ul>
            </div>
          </div>
          <div class="col-lg-auto d-flex flex-wrap justify-content-lg-end gap-2">
            <button type="submit" class="btn btn-outline-warning" id="clearAreaBtn" data-scope="range">De-alloca area</button>
            <button type="submit" class="btn btn-outline-danger" id="clearCategoryBtn" data-scope="all">De-alloca categoria</button>
            <button class="btn btn-primary" id="autoAssignBtn" type="submit">Assegna automaticamente</button>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<h4>Griglia cassettiera</h4>
<div class="legend mb-2">
  <span style="background:black"></span> Bloccata
  {% for c in categories %}
    <span style="background:{{ c.color }}; margin-left:12px;"></span> {{ c.name }}
  {% endfor %}
</div>

<div class="grid-wrap p-2 bg-white">
  {% if grid.rows and grid.cols %}
  <table class="grid-table" id="autoGrid" data-cab="{{ grid.cab.id if grid.cab else '' }}">
    <thead>
      <tr>
        <th class="rowhdr">r\\c</th>
        {% for col in grid.cols %}
          <th>{{ col }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for r in grid.rows %}
      <tr>
        <th class="rowhdr">{{ r }}</th>
        {% for col in grid.cols %}
          {% set key = col ~ '-' ~ r %}
          {% if grid.merge_skips and grid.merge_skips.get(key) %}
          {% else %}
            {% set cell = grid.cells.get(key) %}
            {% set merge = grid.merge_anchors.get(key) if grid.merge_anchors else None %}
            {% set cell_label = cell.label if cell and cell.label else col ~ r %}
            {% set cell_custom = cell.label_custom if cell else False %}
            {% set display_label = cell_label %}
            {% if not cell_custom and cell and cell.entries and (cell.entries|length)>0 %}
              {% set first_entry = cell.entries[0] %}
              {% set display_label = first_entry.name if first_entry.name else first_entry.text %}
            {% endif %}
            {% if not cell %}
              <td class="cell-empty" data-col="{{ col }}" data-row="{{ r }}" data-cat="" data-label="{{ cell_label }}" data-slot-id="">
                <div class="cell-inner">{{ cell_label }}</div>
              </td>
            {% else %}
              {% if cell.blocked %}
                <td class="cell-blocked" data-col="{{ col }}" data-row="{{ r }}" data-cat="blocked" data-label="{{ display_label }}" data-slot-id="{{ cell.slot_id }}" {% if merge %}rowspan="{{ merge.rowspan }}" colspan="{{ merge.colspan }}"{% endif %}>
                  <div class="cell-inner">{{ cell_label }}</div>
                </td>
              {% else %}
                {% set bg = cell.entries[0].color if cell.entries else '#6c757d' %}
                <td class="cell-used" data-col="{{ col }}" data-row="{{ r }}" data-cat="{{ cell.cat_id or '' }}" data-items='{{ cell.entries|tojson }}' data-label="{{ display_label }}" data-slot-id="{{ cell.slot_id }}" style="background:{{ bg }}" {% if merge %}rowspan="{{ merge.rowspan }}" colspan="{{ merge.colspan }}"{% endif %}>
                  <div class="cell-inner">
                    {% if cell_custom %}
                      <div class="cell-line fw-bold">{{ cell_label }}</div>
                    {% else %}
                      {% if cell.auto_label and (cell.entries|length) > 1 %}
                        <div class="cell-line fw-semibold">{{ cell.label }}</div>
                      {% endif %}
                      {% for e in cell.entries %}
                        <div class="cell-line">{{ e.text }}</div>
                      {% endfor %}
                    {% endif %}
                  </div>
                </td>
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor %}
      </tr>
      {% endfor %}
    </tbody>
  </table>
  {% else %}
    <div class="text-muted p-3">Nessuna cassettiera selezionata.</div>
  {% endif %}
</div>

{% if can_manage_placements %}
<!-- Modal contenuto cella -->
<div class="modal fade slot-modal" id="slotModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Contenuto cella <span id="slotLabel2"></span></h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="slot_cab_id" value="{{ grid.cab.id if grid.cab else '' }}">
        <input type="hidden" id="slot_col_code">
        <input type="hidden" id="slot_row_num">
        <div id="slotEmptyMsg" class="text-muted small d-none">Nessun articolo assegnato a questa cella.</div>
        <table class="table table-sm align-middle mb-0" id="slotItemsTable">
          <thead>
            <tr><th>Articolo</th><th>Pos.</th><th>Q.ta</th><th>Azioni</th></tr>
          </thead>
          <tbody id="slotItemsBody"></tbody>
        </table>
        <div id="slotError" class="text-danger small mt-2 d-none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-outline-secondary" id="btnSlotLabelFromSlot">Nome cassetto…</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal override nome cassetto -->
<div class="modal fade" id="slotLabelModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <form id="slotLabelForm">
        <div class="modal-header">
          <h5 class="modal-title">Nome cassetto <span id="slotLabelTitle"></span></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Chiudi"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="cabinet_id" id="slotLabelCabId" value="{{ grid.cab.id if grid.cab else '' }}">
          <input type="hidden" name="col_code" id="slotLabelCol">
          <input type="hidden" name="row_num" id="slotLabelRow">
          <div class="mb-3">
            <label class="form-label">Visualizzazione cassettiera</label>
            <input type="text" class="form-control" name="display_label" id="slotLabelDisplay" placeholder="Lascia vuoto per usare la sigla standard">
            <div class="form-text">Default: <span id="slotLabelDefault"></span></div>
          </div>
          <div class="mb-3">
            <label class="form-label">Stampa etichette</label>
            <input type="text" class="form-control" name="print_label" id="slotLabelPrint" placeholder="Lascia vuoto per usare la sigla standard">
          </div>
          <div class="alert alert-danger d-none" id="slotLabelError"></div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-primary">Salva</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Chiudi</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<div class="form-section mt-3">
  <div class="d-flex align-items-center justify-content-between mb-2 flex-wrap gap-2">
    <h5 class="mb-0">Articoli da posizionare</h5>
    <a href="{{ url_for('cassettiere') }}" class="btn btn-outline-secondary btn-sm">Vai alla griglia</a>
  </div>
  <div class="table-responsive table-sticky">
    <table class="table table-striped align-middle mb-0" id="tbl">
      <thead><tr><th>ID</th><th>Categoria</th><th>Descrizione</th><th>Misura</th><th>Azioni</th></tr></thead>
      <tbody>
        {% for it in items_to_place %}
        <tr>
          <td>{{ it.id }}</td>
          <td>{% if it.category %}<span class="badge-color" style="background:{{ it.category.color }}"></span>{{ it.category.name }}{% endif %}</td>
          <td>{{ compose_caption(it) }}</td>
          <td>{{ it.thread_size or '' }}</td>
          <td class="text-nowrap">
            <a href="{{ url_for('edit_item', item_id=it.id) }}" class="btn btn-sm btn-outline-primary">Modifica</a>
            <a href="{{ url_for('cassettiere') }}" class="btn btn-sm btn-outline-secondary">Apri griglia</a>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const form = document.getElementById('autoAssignForm');
  const actionInput = document.getElementById('formAction');
  const clearScopeInput = document.getElementById('clearScope');
  const startColInput = document.getElementById('start_col');
  const startRowInput = document.getElementById('start_row');
  const primaryKeySelect = document.getElementById('primaryKeySelect');
  const secondaryKeySelect = document.getElementById('secondaryKeySelect');
  const tertiaryKeySelect = document.getElementById('tertiaryKeySelect');
  const quaternaryKeySelect = document.getElementById('quaternaryKeySelect');
  const previewList = document.getElementById('sortPreviewList');

  function escapeHtml(str){
    return (str || '').replace(/[&<>"']/g, function(m) {
      return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m] || m);
    });
  }
  function initCellPopovers(gridId){
    const grid = document.getElementById(gridId);
    if (!grid || typeof bootstrap === 'undefined') return;
    grid.querySelectorAll('td.cell-used').forEach(td=>{
      const raw = td.dataset.items;
      if (!raw) return;
      let items = [];
      try { items = JSON.parse(raw); } catch { items = []; }
      if (!items.length) return;
      const content = items.map(it=>{
        const detailParts = [];
        if (it.thread_size) detailParts.push(it.thread_size);
        if (it.main_measure && it.main_measure.value) detailParts.push(`${it.main_measure.label}: ${it.main_measure.value}`);
        if (it.quantity !== null && it.quantity !== undefined) detailParts.push(`Q.ta ${it.quantity}`);
        if (it.share_drawer) detailParts.push('Condividi cassetto');
        return `
          <div class="d-flex align-items-start mb-1">
            <span class="badge-color flex-shrink-0 mt-1" style="background:${it.color || '#999'};"></span>
            <div class="ms-2">
              <div class="fw-semibold">${escapeHtml(it.name || it.text || '')}</div>
              ${it.description ? `<div class="small text-muted">${escapeHtml(it.description)}</div>` : ''}
              ${detailParts.length ? `<div class="small">${detailParts.map(escapeHtml).join(' - ')}</div>` : ''}
              ${it.position ? `<div class="small text-muted">Pos: ${escapeHtml(it.position)}</div>` : ''}
            </div>
          </div>`;
      }).join('');
      new bootstrap.Popover(td, {
        trigger:'hover focus',
        placement:'top',
        html:true,
        title:'Dettaglio cassetto',
        content: `<div class="popover-items">${content}</div>`
      });
    });
  }

  const SLOT_ITEMS_URL = '{{ url_for("slot_items") }}';
  const CLEAR_URL_TEMPLATE = '{{ url_for("slot_clear_item", item_id=0) }}';
  const SLOT_LABEL_URL = '{{ url_for("slot_label_endpoint") }}';

  async function openSlotLabelModal(col, row){
    const grid = document.getElementById('autoGrid');
    const cabId = grid?.dataset?.cab;
    const modalRoot = document.getElementById('slotLabelModal');
    if (!modalRoot) return;
    const errEl = document.getElementById('slotLabelError');
    if (errEl) {
      errEl.classList.add('d-none');
      errEl.textContent = '';
    }
    if (!cabId || !col || !row) {
      alert('Seleziona prima una cassettiera e una cella.');
      return;
    }
    try {
      const resp = await fetch(`${SLOT_LABEL_URL}?cabinet_id=${encodeURIComponent(cabId)}&col_code=${encodeURIComponent(col)}&row_num=${encodeURIComponent(row)}`);
      const j = await resp.json().catch(()=>({ok:false}));
      if (!resp.ok || !j.ok) {
        alert(j.error || 'Errore nel caricamento del nome cassetto.');
        return;
      }
      document.getElementById('slotLabelCol').value = col;
      document.getElementById('slotLabelRow').value = row;
      document.getElementById('slotLabelCabId').value = cabId;
      document.getElementById('slotLabelDisplay').value = j.display_label || '';
      document.getElementById('slotLabelPrint').value = j.print_label || '';
      document.getElementById('slotLabelDefault').textContent = j.default_label || `${col}${row}`;
      document.getElementById('slotLabelTitle').textContent = j.effective_display_label || `${col}${row}`;
      const modal = new bootstrap.Modal(modalRoot);
      modal.show();
    } catch (e) {
      alert('Errore di comunicazione.');
    }
  }

  function openSlotModal(col, row, labelText){
    const grid = document.getElementById('autoGrid');
    const cabId = grid?.dataset?.cab;
    if (!cabId) return;

    const modalEl = document.getElementById('slotModal');
    if (!modalEl) return;
    const modal = new bootstrap.Modal(modalEl);

    document.getElementById('slotLabel2').textContent = labelText || `${col}${row}`;
    document.getElementById('slot_col_code').value = col;
    document.getElementById('slot_row_num').value = row;
    document.getElementById('slotError').classList.add('d-none');
    document.getElementById('slotEmptyMsg').classList.add('d-none');

    const tbody = document.getElementById('slotItemsBody');
    tbody.innerHTML = '<tr><td colspan="4"><small class="text-muted">Caricamento...</small></td></tr>';

    fetch(`${SLOT_ITEMS_URL}?cabinet_id=${encodeURIComponent(cabId)}&col_code=${encodeURIComponent(col)}&row_num=${encodeURIComponent(row)}`)
      .then(r => r.json())
      .then(j => {
        tbody.innerHTML = '';
        if (!j.ok) {
          document.getElementById('slotError').textContent = j.error || 'Errore caricamento contenuto.';
          document.getElementById('slotError').classList.remove('d-none');
          return;
        }
        const lbl2 = document.getElementById('slotLabel2');
        if (lbl2) {
          lbl2.textContent = j.slot_label_display || labelText || `${col}${row}`;
        }
        if (!j.items || !j.items.length) {
          document.getElementById('slotEmptyMsg').classList.remove('d-none');
          return;
        }

        j.items.forEach(it => {
          const tr = document.createElement('tr');

          const tdName = document.createElement('td');
          const measureInfo = (it.main_measure && it.main_measure.value)
            ? `${it.main_measure.label || (it.main_measure.mode === 'thickness' ? 'Spessore' : 'Lunghezza')}: ${it.main_measure.value} mm`
            : null;
          tdName.innerHTML = `
            <div class="d-flex align-items-start">
              <span class="badge-color flex-shrink-0 mt-1" style="background:${it.color};"></span>
              <div class="ms-2">
                <div class="fw-semibold">${escapeHtml(it.name)}</div>
                ${measureInfo ? `<div class="text-muted small">${escapeHtml(measureInfo)}</div>` : ''}
              </div>
            </div>`;

          const tdPos = document.createElement('td');
          tdPos.textContent = it.position_code || it.position || '';

          const tdQty = document.createElement('td');
          tdQty.textContent = (it.quantity !== null && it.quantity !== undefined) ? it.quantity : '';

          const tdActions = document.createElement('td');
          tdActions.className = 'text-nowrap';
          tdActions.innerHTML = `
            <button type="button" class="btn btn-sm btn-outline-primary me-1" data-edit-id="${it.id}">Modifica</button>
            <button type="button" class="btn btn-sm btn-outline-danger" data-remove-id="${it.id}">Rimuovi posizione</button>
          `;

          tr.appendChild(tdName);
          tr.appendChild(tdPos);
          tr.appendChild(tdQty);
          tr.appendChild(tdActions);
          tbody.appendChild(tr);
        });

        tbody.querySelectorAll('button[data-edit-id]').forEach(btn => {
          btn.addEventListener('click', () => {
            const id = btn.getAttribute('data-edit-id');
            window.location.href = '/admin/items/' + id + '/edit';
          });
        });

        tbody.querySelectorAll('button[data-remove-id]').forEach(btn => {
          btn.addEventListener('click', async () => {
            const id = btn.getAttribute('data-remove-id');
            if (!confirm('Rimuovere la posizione per questo articolo?')) return;
            try {
              const url = CLEAR_URL_TEMPLATE.replace('0', id);
              const resp = await fetch(url, { method: 'POST' });
              const jj = await resp.json().catch(()=>({ok:false}));
              if (!jj.ok) {
                alert(jj.error || 'Errore nella rimozione.');
                return;
              }
              const inst = bootstrap.Modal.getInstance(modalEl);
              if (inst) inst.hide();
              location.reload();
            } catch (e) {
              alert('Errore di comunicazione.');
            }
          });
        });
      })
      .catch(() => {
        tbody.innerHTML = '';
        document.getElementById('slotError').textContent = 'Errore di comunicazione.';
        document.getElementById('slotError').classList.remove('d-none');
      });

    modal.show();
  }

  const categorySelect = document.getElementById('categorySelect');
  const countInput = document.getElementById('countInput');
  const unplacedCount = document.getElementById('unplacedCount');
  if (categorySelect && countInput) {
    categorySelect.addEventListener('change', function() {
      const selected = categorySelect.options[categorySelect.selectedIndex];
      const unplacedValue = selected ? selected.dataset.unplaced : '';
      countInput.value = unplacedValue ?? 0;
      if (unplacedCount) {
        unplacedCount.textContent = unplacedValue ?? '';
      }
    });
  }
  const grid = document.getElementById('autoGrid');
  if (grid) {
    initCellPopovers('autoGrid');
    let pendingUsedCell = null;
    grid.addEventListener('click', function(e){
      const td = e.target.closest('td');
      if (!td) return;
      if (td.classList.contains('cell-blocked')) {
        alert('Cella bloccata, non utilizzabile.');
        return;
      }
      const col = td.dataset.col;
      const row = td.dataset.row;
      const label = td.dataset.label;
      if (!col || !row) return;
      if (startColInput) startColInput.value = col;
      if (startRowInput) startRowInput.value = row;
      grid.querySelectorAll('td').forEach(c => c.classList.remove('table-primary'));
      td.classList.add('table-primary');

      if (td.classList.contains('cell-used')) {
        const cellKey = `${col}-${row}`;
        if (pendingUsedCell === cellKey) {
          pendingUsedCell = null;
          openSlotModal(col, row, label);
        } else {
          pendingUsedCell = cellKey;
        }
      } else {
        pendingUsedCell = null;
      }
    });
  }

  const btnSlotLabelFromSlot = document.getElementById('btnSlotLabelFromSlot');
  if (btnSlotLabelFromSlot) {
    btnSlotLabelFromSlot.addEventListener('click', () => {
      const col = document.getElementById('slot_col_code').value;
      const row = document.getElementById('slot_row_num').value;
      if (!col || !row) return;
      openSlotLabelModal(col, row);
    });
  }

  const slotLabelForm = document.getElementById('slotLabelForm');
  if (slotLabelForm) {
    slotLabelForm.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      const fd = new FormData(slotLabelForm);
      const errEl = document.getElementById('slotLabelError');
      if (errEl) {
        errEl.classList.add('d-none');
        errEl.textContent = '';
      }
      try {
        const resp = await fetch(SLOT_LABEL_URL, { method: 'POST', body: fd });
        const j = await resp.json().catch(()=>({ok:false, error:'Errore di parsing'}));
        if (!resp.ok || !j.ok) {
          if (errEl) {
            errEl.textContent = j.error || 'Errore durante il salvataggio.';
            errEl.classList.remove('d-none');
          } else {
            alert(j.error || 'Errore durante il salvataggio.');
          }
          return;
        }
        const modalEl = document.getElementById('slotLabelModal');
        const inst = bootstrap.Modal.getInstance(modalEl);
        if (inst) inst.hide();
        location.reload();
      } catch (e) {
        alert('Errore di comunicazione.');
      }
    });
  }

  const sampleItems = [
    { name: 'Vite Bombata Croce', subtype: 'Bombata Croce', thread_size: 'M2', length_mm: 8, material: 'Acciaio' },
    { name: 'Vite Bombata Croce', subtype: 'Bombata Croce', thread_size: 'M2', length_mm: 12, material: 'Acciaio' },
    { name: 'Vite Cilindrica Esagonale', subtype: 'Cilindrica Esagonale', thread_size: 'M2', length_mm: 8, material: 'Acciaio' },
    { name: 'Vite Bombata Croce', subtype: 'Bombata Croce', thread_size: 'M2.5', length_mm: 10, material: 'Acciaio' },
    { name: 'Vite Bombata Croce', subtype: 'Bombata Croce', thread_size: 'M3', length_mm: 8, material: 'Acciaio' },
    { name: 'Vite Cilindrica Esagonale', subtype: 'Cilindrica Esagonale', thread_size: 'M3', length_mm: 8, material: 'Inox' },
  ];

  function parseThreadSize(value) {
    const raw = (value || '').trim().toUpperCase();
    const match = raw.match(/^([A-Z]*)(\d+(?:[.,]\d+)?)?/);
    const prefix = match ? match[1] : raw;
    const number = match && match[2] ? parseFloat(match[2].replace(',', '.')) : Number.NaN;
    return { prefix, number };
  }

  function compareValues(a, b) {
    if (a === b) return 0;
    if (a === null || a === undefined || a === '') return 1;
    if (b === null || b === undefined || b === '') return -1;
    if (typeof a === 'number' && typeof b === 'number') return a - b;
    return String(a).localeCompare(String(b), 'it', { numeric: true, sensitivity: 'base' });
  }

  function compareByKey(a, b, key) {
    if (!key) return 0;
    if (key === 'thread_size') {
      const pa = parseThreadSize(a.thread_size);
      const pb = parseThreadSize(b.thread_size);
      const prefixDiff = compareValues(pa.prefix, pb.prefix);
      if (prefixDiff !== 0) return prefixDiff;
      return compareValues(pa.number, pb.number);
    }
    if (key === 'length_mm') return compareValues(a.length_mm, b.length_mm);
    if (key === 'material') return compareValues(a.material, b.material);
    if (key === 'subtype') return compareValues(a.subtype, b.subtype);
    return 0;
  }

  function updatePreview() {
    if (!previewList) return;
    const keys = [
      primaryKeySelect?.value,
      secondaryKeySelect?.value,
      tertiaryKeySelect?.value,
      quaternaryKeySelect?.value,
    ].filter(Boolean);
    const sorted = [...sampleItems].sort((a, b) => {
      for (const key of keys) {
        const diff = compareByKey(a, b, key);
        if (diff !== 0) return diff;
      }
      return 0;
    });
    previewList.innerHTML = sorted.map(item => {
      const label = `${item.name} ${item.thread_size} L${item.length_mm} ${item.material}`;
      return `<li>${escapeHtml(label)}</li>`;
    }).join('');
  }

  [primaryKeySelect, secondaryKeySelect, tertiaryKeySelect, quaternaryKeySelect].forEach(sel => {
    if (!sel) return;
    sel.addEventListener('change', updatePreview);
  });
  updatePreview();

  if (form) {
    form.addEventListener('submit', function(ev){
      const submitter = ev.submitter || null;
      const isClearArea = submitter && submitter.id === 'clearAreaBtn';
      const isClearCategory = submitter && submitter.id === 'clearCategoryBtn';
      const isAutoAssign = !isClearArea && !isClearCategory;

      const colVal = (startColInput?.value || '').trim().toUpperCase();
      const rowVal = (startRowInput?.value || '').trim();
      const countVal = parseInt(document.getElementById('countInput')?.value || '0', 10);
      const direction = (document.querySelector('select[name=\"direction\"]')?.value || 'H').toUpperCase();

      if (startColInput) startColInput.value = colVal;
      if (startRowInput) startRowInput.value = rowVal;

      if (isAutoAssign) {
        if (!colVal || !rowVal) {
          ev.preventDefault();
          alert('Seleziona una cella di partenza cliccando sulla griglia o compilando i campi dedicati.');
          return;
        }
        if (actionInput) actionInput.value = 'auto_assign';
        if (clearScopeInput) clearScopeInput.value = 'all';
        return;
      }

      // da qui: pulsanti di de-allocazione
      const scope = isClearArea ? 'range' : 'all';
      if (!actionInput || !clearScopeInput) {
        ev.preventDefault();
        alert('Impossibile inviare il comando: input nascosti mancanti.');
        return;
      }
      clearScopeInput.value = scope;
      actionInput.value = 'clear_category';

      if (isClearArea) {
        if (!colVal || !rowVal || !countVal || Number.isNaN(countVal) || countVal <= 0) {
          ev.preventDefault();
          alert('Per de-allocare un\'area, compila colonna, riga e numero di celle.');
          return;
        }
        const dirLabel = direction === 'V' ? 'verticale' : 'orizzontale';
        const rangeConfirm = confirm(`De-allocare ${countVal} celle (${dirLabel}) a partire da ${colVal}${rowVal}?`);
        if (!rangeConfirm) { ev.preventDefault(); return; }
      } else {
        const fullConfirm = confirm('Confermi di voler de-allocare TUTTA la categoria dalla cassettiera selezionata?');
        if (!fullConfirm) { ev.preventDefault(); return; }
      }
      const safetyConfirm = confirm('Operazione invasiva: sarà necessario ristampare tutte le etichette e riposizionare i cassetti. Procedere comunque?');
      if (!safetyConfirm) { ev.preventDefault(); return; }
    });
  }

  if ($.fn.DataTable) {
    $('#tbl').DataTable({
      pageLength:50,
      lengthMenu:[10, 25, 50, 100],
      order:[[1,'asc']],
      language: { search: "Cerca nella tabella:" }
    });
  }
});
</script>
{% endblock %}
