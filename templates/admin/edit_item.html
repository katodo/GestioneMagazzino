{% extends "base.html" %}
{% block content %}
<h3>Modifica articolo #{{ item.id }}</h3>
<form method="post" class="form-section needs-validation" novalidate>
  <div class="row g-2">
    <div class="col-md-4 field-block" data-field-key="category_id">
      <label class="form-label">Categoria</label>
      <select class="form-select" name="category_id" id="catSel" required>
        {% for c in categories %}
          <option value="{{ c.id }}" {{ 'selected' if item.category_id==c.id else '' }}>{{ c.name }}</option>
        {% endfor %}
      </select>
      <div class="invalid-feedback">Seleziona una categoria.</div>
    </div>
    <div class="col-md-4 field-block" data-field-key="subtype_id">
      <label class="form-label">Sottotipo (forma)</label>
      <select class="form-select" name="subtype_id" id="subtypeSel">
        <option value="">—</option>
      </select>
    </div>
    <div class="col-md-4 field-block" data-field-key="thread_standard">
      <label class="form-label">Standard</label>
      <select class="form-select" name="thread_standard" id="stdSel">
        {% for std in thread_standards %}
          <option value="{{ std.code }}" {{ 'selected' if item.thread_standard==std.code else '' }}>{{ std.label }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-4 field-block" data-field-key="thread_size">
      <label class="form-label">Misura</label>
      <input class="form-control" name="thread_size" id="sizeInput" value="{{ item.thread_size or '' }}" list="sizes-{{ item.thread_standard or (thread_standards[0].code if thread_standards else '') }}">
      {% for std in thread_standards %}
        <datalist id="sizes-{{ std.code }}">
          {% for s in sizes_by_standard.get(std.code, []) %}<option value="{{ s }}">{% endfor %}
        </datalist>
      {% endfor %}
    </div>
    <div class="col-md-4 field-block" data-field-key="outer_d_mm">
      <label class="form-label">Ø esterno (mm)</label>
      <input type="number" step="0.01" class="form-control" name="outer_d_mm" value="{{ item.outer_d_mm or '' }}">
    </div>
    <div class="col-md-4 field-block" data-field-key="length_mm">
      <label class="form-label">Lunghezza/Spessore (mm)</label>
      <input type="number" step="0.01" class="form-control" name="length_mm" value="{{ item.length_mm if item.length_mm is not none else '' }}">
    </div>
    <div class="col-md-2 field-block" data-field-key="inner_d_mm">
      <label class="form-label">Ø interno (mm)</label>
      <input type="number" step="0.01" class="form-control" name="inner_d_mm" value="{{ item.inner_d_mm or '' }}">
    </div>

    <div class="col-md-6 field-block" data-field-key="material_id">
      <label class="form-label">Materiale</label>
      <select class="form-select" name="material_id">
        <option value="">—</option>
        {% for m in materials %}
          <option value="{{ m.id }}" {{ 'selected' if item.material_id==m.id else '' }}>{{ m.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-6 field-block" data-field-key="finish_id">
      <label class="form-label">Finitura</label>
      <select class="form-select" name="finish_id">
        <option value="">—</option>
        {% for f in finishes %}
          <option value="{{ f.id }}" {{ 'selected' if item.finish_id==f.id else '' }}>{{ f.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div class="col-md-12 field-block" data-field-key="description">
      <label class="form-label">Descrizione (opz.)</label>
      <input type="text" class="form-control" name="description" value="{{ item.description or '' }}">
    </div>

    {% if custom_fields %}
    <div class="col-12">
      <label class="form-label d-block">Campi personalizzati</label>
    </div>
    {% for field in custom_fields %}
    <div class="col-md-6 field-block" data-field-key="custom_{{ field.id }}">
      <label class="form-label">{{ field.name }}{% if field.unit %} ({{ field.unit }}){% endif %}</label>
      {% if field.field_type == 'select' %}
        <select class="form-select" name="custom_field_{{ field.id }}">
          <option value="">—</option>
          {% for opt in field.options %}
            <option value="{{ opt }}" {{ 'selected' if custom_field_values.get(field.id) == opt else '' }}>{{ opt }}</option>
          {% endfor %}
        </select>
      {% elif field.field_type == 'number' %}
        <input type="number" step="0.01" class="form-control" name="custom_field_{{ field.id }}" value="{{ custom_field_values.get(field.id, '') }}">
      {% else %}
        <input type="text" class="form-control" name="custom_field_{{ field.id }}" value="{{ custom_field_values.get(field.id, '') }}">
      {% endif %}
    </div>
    {% endfor %}
    {% endif %}

    <div class="col-md-4 field-block" data-field-key="quantity">
      <label class="form-label">Quantità</label>
      <input type="number" min="0" step="1" class="form-control" name="quantity" value="{{ item.quantity }}">
    </div>

    <div class="col-md-8">
      <label class="form-label d-block">Campi in etichetta</label>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="label_show_category" {{ 'checked' if item.label_show_category else '' }}>
        <label class="form-check-label">Categoria</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="label_show_subtype" {{ 'checked' if item.label_show_subtype else '' }}>
        <label class="form-check-label">Sottotipo</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="label_show_thread" {{ 'checked' if item.label_show_thread else '' }}>
        <label class="form-check-label">Filettatura</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="label_show_measure" {{ 'checked' if item.label_show_measure else '' }}>
        <label class="form-check-label">Misura</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="label_show_main" {{ 'checked' if item.label_show_main else '' }}>
        <label class="form-check-label">Ø esterno/Lunghezza</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input" type="checkbox" name="label_show_material" {{ 'checked' if item.label_show_material else '' }}>
        <label class="form-check-label">Materiale</label>
      </div>
    </div>

    <div class="col-12"><hr></div>

    <div class="col-md-3">
      <label class="form-label">Posizione attuale</label>
      <input class="form-control" value="{{ current_position or '(non assegnata)' }}" readonly>
    </div>

    <div class="col-md-3">
      <label class="form-label">Cassettiera</label>
      <select class="form-select" id="cabinet_id" name="cabinet_id">
        <option value="">(scegli)</option>
        {% for c in cabinets %}<option value="{{ c.id }}" {{ 'selected' if current_cabinet_id==c.id else '' }}>{{ c.name }}</option>{% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label">Colonna</label>
      <input class="form-control" id="col_code" name="col_code" placeholder="es. D" value="{{ current_col_code }}">
    </div>
    <div class="col-md-2">
      <label class="form-label">Riga</label>
      <input type="number" min="1" max="128" class="form-control" id="row_num" name="row_num" value="{{ current_row_num }}">
    </div>
    <div class="col-md-2 d-flex align-items-end">
      <button formaction="{{ url_for('set_position', item_id=item.id) }}" formmethod="post" class="btn btn-outline-primary w-100">Imposta</button>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <button type="button" id="btnSuggest" class="btn btn-outline-secondary w-100">Suggerisci</button>
    </div>
    <div class="col-md-3 d-flex align-items-end">
      <form method="post" action="{{ url_for('clear_position', item_id=item.id) }}" onsubmit="return confirm('Rimuovere posizione?')">
        <button class="btn btn-outline-danger w-100">Rimuovi</button>
      </form>
    </div>

    <div class="col-12 text-end mt-3">
      <button class="btn btn-primary">Salva modifiche</button>
      <a href="{{ url_for('admin_items') }}" class="btn btn-secondary">Chiudi</a>
    </div>
  </div>
</form>

<script>
const SUBTYPES = {{ subtypes_by_cat|tojson }};
const CATEGORY_FIELDS = {{ category_fields|tojson }};

function populateSubtypes(catId){
  const sel = document.getElementById('subtypeSel');
  sel.innerHTML = '<option value="">—</option>';
  if (!catId || !SUBTYPES[catId]) return;
  SUBTYPES[catId].forEach(s=>{
    const o = document.createElement('option');
    o.value = s.id; o.textContent = s.name;
    if ({{ item.subtype_id or 'null' }} === s.id) o.selected = true;
    sel.appendChild(o);
  });
}
function applyFieldVisibility(catId){
  if (!catId || !CATEGORY_FIELDS[catId]) {
    document.querySelectorAll('[data-field-key]').forEach(el=>{ el.style.display = ''; });
    return;
  }
  const enabled = new Set(CATEGORY_FIELDS[catId]);
  document.querySelectorAll('[data-field-key]').forEach(el=>{
    const key = el.dataset.fieldKey;
    if (key === 'category_id') {
      el.style.display = '';
      return;
    }
    if (key === 'length_mm') {
      el.style.display = (enabled.has('length_mm') || enabled.has('thickness_mm')) ? '' : 'none';
      return;
    }
    el.style.display = enabled.has(key) ? '' : 'none';
  });
}
function switchDatalist(){
  const std = document.getElementById('stdSel').value;
  const inp = document.getElementById('sizeInput');
  if (!std) {
    inp.removeAttribute('list');
    return;
  }
  const listId = `sizes-${std}`;
  if (document.getElementById(listId)) {
    inp.setAttribute('list', listId);
  } else {
    inp.removeAttribute('list');
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  populateSubtypes({{ item.category_id }});
  applyFieldVisibility({{ item.category_id }});
  switchDatalist();
  document.getElementById('catSel').addEventListener('change', ()=>{
    const catId = parseInt(document.getElementById('catSel').value||0);
    populateSubtypes(catId);
    applyFieldVisibility(catId);
  });
  document.getElementById('stdSel').addEventListener('change', switchDatalist);
  document.getElementById('btnSuggest').addEventListener('click', async ()=>{
    const r = await fetch('{{ url_for("suggest_position", item_id=item.id) }}');
    const j = await r.json();
    if (!j.ok) { alert(j.error||'Nessuna posizione trovata'); return; }
    document.getElementById('cabinet_id').value = j.cabinet_id;
    document.getElementById('col_code').value  = j.col_code;
    document.getElementById('row_num').value   = j.row_num;
  });
});
</script>
{% endblock %}
