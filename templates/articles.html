{% extends "base.html" %}
{% block content %}
<div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
  <div>
    <h3 class="mb-1">Articoli</h3>
    <div class="text-muted small">Un'unica griglia per consultare e gestire il catalogo; accedi per modificare o aggiungere.</div>
  </div>
  {% if is_admin %}
    <div class="d-flex flex-wrap gap-2">
      <a href="#newItemForm" class="btn btn-primary btn-sm">Nuovo articolo</a>
      <a href="{{ url_for('export_items_csv') }}" class="btn btn-outline-dark btn-sm">Esporta CSV</a>
    </div>
  {% endif %}
</div>

<div class="row g-3 mb-3">
  <div class="col-lg-3 col-md-6">
    <div class="kpi-card h-100">
      <div class="kpi-label">Articoli totali</div>
      <p class="kpi-value">{{ total_items }}</p>
      <div class="text-muted small">Inventario completo</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="kpi-card h-100">
      <div class="kpi-label">Categorie</div>
      <p class="kpi-value">{{ total_categories }}</p>
      <div class="text-muted small">Organizzazione</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="kpi-card h-100">
      <div class="kpi-label">Scorte basse</div>
      <p class="kpi-value">{{ low_stock_count }}</p>
      <div class="text-muted small">≤ {{ low_stock_threshold }} pezzi</div>
    </div>
  </div>
  <div class="col-lg-3 col-md-6">
    <div class="kpi-card h-100">
      <div class="kpi-label">Da posizionare</div>
      <p class="kpi-value">{{ unplaced_count }}</p>
      <div class="text-muted small">In attesa di posizione</div>
    </div>
  </div>
</div>

{% if is_admin %}
<div class="form-section mb-3" id="newItemForm">
  <h5 class="mb-2">Nuovo articolo</h5>
  <form method="post" action="{{ url_for('add_item') }}" class="needs-validation" novalidate>
    <div class="row g-2">
      <div class="col-md-6 field-block" data-field-key="category_id">
        <label class="form-label">Categoria</label>
        <select class="form-select" name="category_id" id="catSel" required>
          <option value="">—</option>
          {% for c in categories %}
            <option value="{{ c.id }}" {{ 'selected' if (request.args.get('keep_category_id')|int)==c.id else '' }}>{{ c.name }}</option>
          {% endfor %}
        </select>
        <div class="invalid-feedback">Seleziona una categoria.</div>
      </div>
      <div class="col-md-6 field-block" data-field-key="subtype_id">
        <label class="form-label">Sottotipo (forma)</label>
        <select class="form-select" name="subtype_id" id="subtypeSel">
          <option value="">—</option>
        </select>
      </div>

      <div class="col-md-4 field-block" data-field-key="thread_standard">
        <label class="form-label">Standard</label>
        <select class="form-select" name="thread_standard" id="stdSel">
          {% for std in thread_standards %}
            <option value="{{ std.code }}" {{ 'selected' if std.code == default_standard_code else '' }}>{{ std.label }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-8 field-block" data-field-key="thread_size">
        <label class="form-label">Misura (es. M3 / 1/4-20)</label>
        <input class="form-control" name="thread_size" id="sizeInput" list="sizes-{{ default_standard_code }}" value="{{ request.args.get('keep_thread_size','') }}">
        {% for std in thread_standards %}
          <datalist id="sizes-{{ std.code }}">
            {% for s in sizes_by_standard.get(std.code, []) %}<option value="{{ s }}">{% endfor %}
          </datalist>
        {% endfor %}
      </div>

      <div class="col-md-4 field-block" data-field-key="outer_d_mm">
        <label class="form-label">Ø esterno (mm)</label>
        <input type="number" step="0.01" class="form-control" name="outer_d_mm">
      </div>
      <div class="col-md-4 field-block" data-field-key="length_mm">
        <label class="form-label">Lunghezza/Spessore (mm)</label>
        <input type="number" step="0.01" class="form-control" name="length_mm">
      </div>
      <div class="col-md-2 field-block" data-field-key="inner_d_mm">
        <label class="form-label">Ø interno (mm)</label>
        <input type="number" step="0.01" class="form-control" name="inner_d_mm">
      </div>

      <div class="col-md-6 field-block" data-field-key="material_id">
        <label class="form-label">Materiale</label>
        <select class="form-select" name="material_id">
          <option value="">—</option>
          {% for m in materials %}<option value="{{ m.id }}" {{ 'selected' if (request.args.get('keep_material_id')|int)==m.id else '' }}>{{ m.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-6 field-block" data-field-key="finish_id">
        <label class="form-label">Finitura</label>
        <select class="form-select" name="finish_id">
          <option value="">—</option>
          {% for f in finishes %}<option value="{{ f.id }}" {{ 'selected' if (request.args.get('keep_finish_id')|int)==f.id else '' }}>{{ f.name }}</option>{% endfor %}
        </select>
      </div>

      <div class="col-md-12 field-block" data-field-key="description">
        <label class="form-label">Descrizione (opz.)</label>
        <input type="text" class="form-control" name="description" value="{{ request.args.get('keep_description','') }}">
      </div>

      {% if custom_fields %}
      <div class="col-12">
        <label class="form-label d-block">Campi personalizzati</label>
      </div>
      {% for field in custom_fields %}
      <div class="col-md-6 field-block" data-field-key="custom_{{ field.id }}">
        <label class="form-label">{{ field.name }}{% if field.unit %} ({{ field.unit }}){% endif %}</label>
        {% if field.field_type == 'select' %}
          <select class="form-select" name="custom_field_{{ field.id }}">
            <option value="">—</option>
            {% for opt in field.options %}
              <option value="{{ opt }}">{{ opt }}</option>
            {% endfor %}
          </select>
        {% elif field.field_type == 'number' %}
          <input type="number" step="0.01" class="form-control" name="custom_field_{{ field.id }}">
        {% else %}
          <input type="text" class="form-control" name="custom_field_{{ field.id }}">
        {% endif %}
      </div>
      {% endfor %}
      {% endif %}

      <div class="col-md-4 field-block" data-field-key="quantity">
        <label class="form-label">Quantità</label>
        <input type="number" min="0" step="1" class="form-control" name="quantity" value="0">
      </div>

      <div class="col-12"><hr></div>

      <div class="col-md-4">
        <label class="form-label">Cassettiera</label>
        <select class="form-select" name="cabinet_id">
          <option value="">(assegna dopo)</option>
          {% for c in cabinets %}<option value="{{ c.id }}">{{ c.name }}</option>{% endfor %}
        </select>
      </div>
      <div class="col-md-4">
        <label class="form-label">Colonna (A..ZZ)</label>
        <input class="form-control" name="col_code" placeholder="es. D">
      </div>
      <div class="col-md-4">
        <label class="form-label">Riga (1..128)</label>
        <input type="number" min="1" max="128" class="form-control" name="row_num">
      </div>

      <div class="col-12"><hr></div>

      <div class="col-md-4 field-block" data-field-key="share_drawer">
        <label class="form-label">Condividi cassetto</label>
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="share_drawer" id="shareDrawerNew">
          <label class="form-check-label" for="shareDrawerNew">Permetti di condividere il cassetto con altri articoli compatibili</label>
        </div>
      </div>
      <div class="col-md-8">
        <label class="form-label d-block">Campi in etichetta</label>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="label_show_category" checked>
          <label class="form-check-label">Categoria</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="label_show_subtype" checked>
          <label class="form-check-label">Sottotipo</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="label_show_thread" checked>
          <label class="form-check-label">Filettatura</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="label_show_measure" checked>
          <label class="form-check-label">Misura</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="label_show_main" checked>
          <label class="form-check-label">Ø esterno/Lunghezza</label>
        </div>
        <div class="form-check form-check-inline">
          <input class="form-check-input" type="checkbox" name="label_show_material" checked>
          <label class="form-check-label">Materiale</label>
        </div>
      </div>

      <div class="col-12 text-end">
        <button class="btn btn-primary">Salva</button>
      </div>
    </div>
  </form>
</div>
{% endif %}

<div class="form-section">
  <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-2">
    <h5 class="mb-0">Griglia articoli</h5>
    {% if is_admin %}
      <div class="d-flex flex-wrap gap-2">
        <button class="btn btn-sm btn-primary" type="submit" form="labelForm" formaction="{{ url_for('labels_pdf') }}">Stampa etichette</button>
        <button class="btn btn-sm btn-outline-primary" type="submit" form="labelForm" formaction="{{ url_for('cards_pdf') }}">Stampa cartellini</button>
      </div>
    {% endif %}
  </div>

  <form id="itemFilter" method="get" action="{{ url_for('articles') }}" class="row g-2 align-items-end mb-3">
    <div class="col-md-3">
      <label class="form-label small text-muted mb-1">Ricerca</label>
      <input type="text" name="q" class="form-control" placeholder="Nome, descrizione o filettatura" value="{{ request.args.get('q','') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted mb-1">Categoria</label>
      <select name="category_id" class="form-select">
        <option value="">Tutte</option>
        {% for c in categories %}
          <option value="{{ c.id }}" {{ 'selected' if (request.args.get('category_id')|int)==c.id else '' }}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted mb-1">Materiale</label>
      <select name="material_id" class="form-select">
        <option value="">Tutti</option>
        {% for m in materials %}
          <option value="{{ m.id }}" {{ 'selected' if (request.args.get('material_id')|int)==m.id else '' }}>{{ m.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted mb-1">Finitura</label>
      <select name="finish_id" class="form-select">
        <option value="">Tutte</option>
        {% for f in finishes %}
          <option value="{{ f.id }}" {{ 'selected' if (request.args.get('finish_id')|int)==f.id else '' }}>{{ f.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted mb-1">Misura</label>
      <input type="text" name="measure" class="form-control" placeholder="es. M3" value="{{ measure_q }}">
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted mb-1">Condivisione</label>
      <select name="share_drawer" class="form-select">
        <option value="">Tutte</option>
        <option value="1" {{ 'selected' if request.args.get('share_drawer')=='1' else '' }}>Condivisibili</option>
        <option value="0" {{ 'selected' if request.args.get('share_drawer')=='0' else '' }}>Non condivise</option>
      </select>
    </div>
    <div class="col-md-3">
      <label class="form-label small text-muted mb-1">Cassettiera</label>
      <select name="pos_cabinet_id" class="form-select">
        <option value="">Tutte</option>
        {% for c in cabinets %}
          <option value="{{ c.id }}" {{ 'selected' if (request.args.get('pos_cabinet_id')|int)==c.id else '' }}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted mb-1">Colonna</label>
      <input type="text" name="pos_col" class="form-control" placeholder="A..ZZ" value="{{ request.args.get('pos_col','') }}">
    </div>
    <div class="col-md-2">
      <label class="form-label small text-muted mb-1">Riga</label>
      <input type="number" min="1" max="128" name="pos_row" class="form-control" placeholder="1..128" value="{{ request.args.get('pos_row','') }}">
    </div>
    <div class="col-md-3 d-flex flex-wrap gap-2">
      <button class="btn btn-outline-primary btn-sm flex-grow-1">Filtra</button>
      <a href="{{ url_for('articles') }}" class="btn btn-outline-secondary btn-sm">Reset</a>
    </div>
    <div class="col-12 d-flex flex-wrap gap-2">
      <a class="btn btn-outline-dark btn-sm {{ 'active' if stock_filter == 'available' else '' }}" href="{{ url_for('articles', stock='available', q=request.args.get('q'), category_id=request.args.get('category_id'), material_id=request.args.get('material_id'), finish_id=request.args.get('finish_id'), measure=request.args.get('measure'), pos_cabinet_id=request.args.get('pos_cabinet_id'), pos_col=request.args.get('pos_col'), pos_row=request.args.get('pos_row'), share_drawer=request.args.get('share_drawer')) }}">Disponibili</a>
      <a class="btn btn-outline-warning btn-sm {{ 'active' if stock_filter == 'low' else '' }}" href="{{ url_for('articles', stock='low', q=request.args.get('q'), category_id=request.args.get('category_id'), material_id=request.args.get('material_id'), finish_id=request.args.get('finish_id'), measure=request.args.get('measure'), pos_cabinet_id=request.args.get('pos_cabinet_id'), pos_col=request.args.get('pos_col'), pos_row=request.args.get('pos_row'), share_drawer=request.args.get('share_drawer')) }}">Scorte basse</a>
      <a class="btn btn-outline-danger btn-sm {{ 'active' if stock_filter == 'out' else '' }}" href="{{ url_for('articles', stock='out', q=request.args.get('q'), category_id=request.args.get('category_id'), material_id=request.args.get('material_id'), finish_id=request.args.get('finish_id'), measure=request.args.get('measure'), pos_cabinet_id=request.args.get('pos_cabinet_id'), pos_col=request.args.get('pos_col'), pos_row=request.args.get('pos_row'), share_drawer=request.args.get('share_drawer')) }}">Esauriti</a>
    </div>
  </form>

  {% if is_admin %}
  <form id="labelForm" method="post" action="{{ url_for('labels_pdf') }}">
  {% endif %}
    <div class="table-responsive table-sticky">
      <table class="table table-striped table-hover align-middle mb-0" id="articlesTable">
        <thead>
          <tr>
            {% if is_admin %}<th style="width:36px;"><input type="checkbox" id="chkAll"></th>{% endif %}
            <th>ID</th>
            <th>Categoria</th>
            <th>Nome</th>
            <th>Misura</th>
            <th>Ø esterno (mm)</th>
            <th>Lunghezza/Spessore (mm)</th>
            <th>Materiale</th>
            <th>Q.ta</th>
            <th>Posizione</th>
            {% if is_admin %}<th>Condiviso</th>
            <th>Azione</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr {% if is_admin %}data-edit-url="{{ url_for('edit_item', item_id=it.id) }}"{% endif %}>
            {% if is_admin %}<td><input type="checkbox" name="item_ids" value="{{ it.id }}"></td>{% endif %}
            <td>{{ it.id }}</td>
            <td>{% if it.category %}<span class="badge-color" style="background:{{ it.category.color }}"></span>{{ it.category.name }}{% endif %}</td>
            <td>{{ compose_caption(it) }}</td>
            <td>{{ it.thread_size or "" }}</td>
            <td>{{ '%.2f'|format(it.outer_d_mm) if it.outer_d_mm is not none else '' }}</td>
            <td>{{ '%.2f'|format(it.length_mm) if it.length_mm is not none else '' }}</td>
            <td>{{ it.material.name if it.material else '' }}</td>
            <td>
              {% if it.quantity <= 0 %}
                <span class="badge bg-danger badge-stock">Esaurito</span>
              {% elif it.quantity <= low_stock_threshold %}
                <span class="badge bg-warning text-dark badge-stock">Scorte basse</span>
              {% else %}
                <span class="badge bg-success badge-stock">Disponibile</span>
              {% endif %}
              <span class="ms-2 fw-semibold">{{ it.quantity }}</span>
            </td>
            <td>{{ pos_by_item.get(it.id, '') }}</td>
            {% if is_admin %}
            <td class="text-center">{% if it.share_drawer %}&#10003;{% endif %}</td>
            <td class="text-nowrap">
              <a href="{{ url_for('edit_item', item_id=it.id) }}" class="btn btn-sm btn-outline-primary">Modifica</a>
              <form method="post" action="{{ url_for('delete_item', item_id=it.id) }}" class="d-inline" onsubmit="return confirm('Eliminare articolo?')">
                <button class="btn btn-sm btn-outline-danger">Elimina</button>
              </form>
            </td>
            {% endif %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% if is_admin %}
  </form>
  {% endif %}
</div>

<script>
const SUBTYPES = {{ subtypes_by_cat|tojson }};
const CATEGORY_FIELDS = {{ category_fields|tojson }};

function populateSubtypes(catId, targetSelId){
  const sel = document.getElementById(targetSelId);
  if (!sel) return;
  sel.innerHTML = '<option value=\"\">—</option>';
  if (!catId || !SUBTYPES[catId]) return;
  SUBTYPES[catId].forEach(s=>{
    const o = document.createElement('option');
    o.value = s.id; o.textContent = s.name;
    sel.appendChild(o);
  });
}
function applyFieldVisibility(catId){
  if (!catId || !CATEGORY_FIELDS[catId]) {
    document.querySelectorAll('[data-field-key]').forEach(el=>{ el.style.display = ''; });
    return;
  }
  const enabled = new Set(CATEGORY_FIELDS[catId]);
  document.querySelectorAll('[data-field-key]').forEach(el=>{
    const key = el.dataset.fieldKey;
    if (key === 'category_id' || key === 'share_drawer') {
      el.style.display = '';
      return;
    }
    if (key === 'length_mm') {
      el.style.display = (enabled.has('length_mm') || enabled.has('thickness_mm')) ? '' : 'none';
      return;
    }
    el.style.display = enabled.has(key) ? '' : 'none';
  });
}
function switchDatalist(stdSelId, inputId){
  const stdEl = document.getElementById(stdSelId);
  const inp = document.getElementById(inputId);
  if (!stdEl || !inp) return;
  const std = stdEl.value;
  if (!std) {
    inp.removeAttribute('list');
    return;
  }
  const listId = `sizes-${std}`;
  if (document.getElementById(listId)) {
    inp.setAttribute('list', listId);
  } else {
    inp.removeAttribute('list');
  }
}
function clearKeepParams(){
  const params = new URLSearchParams(window.location.search);
  const keys = ["keep_category_id","keep_material_id","keep_finish_id","keep_description","keep_thread_size"];
  let changed = false;
  keys.forEach(k=>{
    if (params.has(k)) { params.delete(k); changed = true; }
  });
  if (changed) {
    const qs = params.toString();
    const newUrl = window.location.pathname + (qs ? `?${qs}` : "") + window.location.hash;
    window.history.replaceState({}, '', newUrl);
  }
}

document.addEventListener('DOMContentLoaded', ()=>{
  const tableSelector = '#articlesTable';
  const excludedSelectors = 'a, button, input, label, select';
  const defaultOrder = {{ '[[1,\"asc\"]]' if is_admin else '[[0,\"asc\"]]' }};
  if ($.fn.DataTable) {
    $(tableSelector).DataTable({
      pageLength:25,
      lengthMenu:[10, 25, 50, 100],
      order: defaultOrder,
      language: { search: "Cerca nella tabella:" }
    });
    {% if is_admin %}
    $(`${tableSelector} tbody`).on('click', 'tr', function(e){
      if ($(e.target).closest(excludedSelectors).length) return;
      const url = this.dataset.editUrl;
      if (url) window.location.href = url;
    });
    $(`${tableSelector} tbody tr`).addClass('cursor-pointer');
    {% endif %}
  } else {
    {% if is_admin %}
    document.querySelectorAll(`${tableSelector} tbody tr`).forEach(row=>{
      row.classList.add('cursor-pointer');
      row.addEventListener('click', (e)=>{
        if (e.target.closest(excludedSelectors)) return;
        const url = row.dataset.editUrl;
        if (url) window.location.href = url;
      });
    });
    {% endif %}
  }
  {% if is_admin %}
  document.getElementById('chkAll')?.addEventListener('change', (e)=>{
    document.querySelectorAll('input[name=\"item_ids\"]').forEach(cb=> cb.checked = e.target.checked);
  });
  const catSel = document.getElementById('catSel');
  const initialCat = parseInt(catSel?.value || 0);
  if (initialCat) {
    populateSubtypes(initialCat, 'subtypeSel');
  }
  applyFieldVisibility(initialCat);
  catSel?.addEventListener('change', e=>{
    const catId = parseInt(e.target.value||0);
    populateSubtypes(catId, 'subtypeSel');
    applyFieldVisibility(catId);
  });
  document.getElementById('stdSel')?.addEventListener('change', ()=>switchDatalist('stdSel','sizeInput'));
  clearKeepParams();

  try {
    const params = new URLSearchParams(window.location.search);
    const cab = params.get('new_for_cab');
    const col = params.get('new_for_col');
    const row = params.get('new_for_row');

    if (cab && col && row) {
      const formNew = document.querySelector('form[action="{{ url_for("add_item") }}"]');
      if (formNew) {
        const cabSel = formNew.querySelector('select[name=\"cabinet_id\"]');
        const colInp = formNew.querySelector('input[name=\"col_code\"]');
        const rowInp = formNew.querySelector('input[name=\"row_num\"]');
        if (cabSel) cabSel.value = cab;
        if (colInp) colInp.value = col;
        if (rowInp) rowInp.value = row;
        cabSel?.scrollIntoView({ behavior: 'smooth', block: 'center' });
      }
    }
  } catch (e) {
  }
  {% endif %}
});

</script>
{% endblock %}
